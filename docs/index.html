<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="pandoc.css" type="text/css" />
  <script type="text/javascript" src="http://livejs.com/live.js"></script>
  <style>.caption{font-style:italic;}</style>
</head>
<body>
<h1 id="pdok-webservices-workshop">PDOK Webservices Workshop</h1>
<!-- TOC -->
<ul>
<li><a href="#pdok-webservices-workshop">PDOK Webservices Workshop</a>
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#pdok-webservices">PDOK webservices</a></li>
<li><a href="#sdi-nl">SDI NL</a></li>
<li><a href="#standards--ogc---geonovum">Standards- OGC - Geonovum</a></li>
<li><a href="#findability--metadata--ngr">Findability / metadata / NGR</a></li>
</ul></li>
<li><a href="#focus-on-map-services">Focus on map services</a>
<ul>
<li><a href="#wms">WMS</a></li>
<li><a href="#tiled-wms">Tiled WMS</a></li>
<li><a href="#vector-tiles">Vector Tiles</a></li>
</ul></li>
</ul></li>
<li><a href="#workshop">Workshop</a>
<ul>
<li><a href="#1-setting-up-npm-project-with-openlayers">1. Setting up NPM project with OpenLayers</a></li>
<li><a href="#2-adding-base-map-to-viewer">2. Adding base map to viewer</a></li>
<li><a href="#3-adding-wms-to-viewer">3. Adding WMS to viewer</a>
<ul>
<li><a href="#31-adding-wms-layer-to-viewer">3.1 Adding WMS layer to viewer</a></li>
<li><a href="#32-adding-featureinfo-on-click-to-viewer">3.2 Adding featureinfo on click to viewer</a></li>
</ul></li>
<li><a href="#4-adding-a-geojson-layer-to-your-map">4. Adding a GeoJSON layer to your map</a>
<ul>
<li><a href="#41-preprocessing-the-data">4.1 Preprocessing the data</a></li>
<li><a href="#42-add-a-geojson-layer-to-the-map">4.2 Add a GeoJSON layer to the map</a></li>
</ul></li>
<li><a href="#5-using-the-pdok-location-server">5. Using the PDOK Location Server</a></li>
</ul></li>
<li><a href="#referenties">Referenties</a></li>
</ul>
<!-- /TOC -->
<h2 id="introduction">Introduction</h2>
<p>In this workshop you will build a dynamic map on a web page displaying the PDOK geo-webservices. The web application is build with OpenLayers version 6.2.1, an Open Source Javascript library.</p>
<p>https://www.dropbox.com/sh/6j3e40thy9pspoi/AACS2NCHaT0h8JbKLTDSpZx9a?dl=0</p>
<h3 id="pdok-webservices">PDOK webservices</h3>
<ul>
<li>Explain what PDOK is.</li>
<li>Explain what services we provide</li>
</ul>
<h3 id="sdi-nl">SDI NL</h3>
<h3 id="standards--ogc---geonovum">Standards- OGC - Geonovum</h3>
<h3 id="findability-metadata-ngr">Findability / metadata / NGR</h3>
<h2 id="focus-on-map-services">Focus on map services</h2>
<p>Explain differences between data en map services. Explain focus on Map services</p>
<h3 id="wms">WMS</h3>
<h3 id="tiled-wms">Tiled WMS</h3>
<h3 id="vector-tiles">Vector Tiles</h3>
<h1 id="workshop">Workshop</h1>
<h2 id="setting-up-npm-project-with-openlayers">1. Setting up NPM project with OpenLayers</h2>
<blockquote>
<p>TODO: Summary of section.</p>
</blockquote>
<p>Run the following commands from the root of this repository:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> webapp <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> webapp
<span class="ex">npm</span> init -y 
<span class="ex">npm</span> install ol
<span class="ex">npm</span> install --save-dev parcel-bundler eslint</code></pre></div>
<p>Then setup ESLint by running <code>eslinit --init</code> and answer questions with:</p>
<ul>
<li>How would you like to use ESLint?
<ul>
<li>To check syntax, find problems, and enforce code style</li>
</ul></li>
<li>What type of modules does your project use? (Use arrow keys)
<ul>
<li>JavaScript modules (import/export)</li>
</ul></li>
<li>Which framework does your project use?
<ul>
<li>None of these</li>
</ul></li>
<li>Does your project use TypeScript?
<ul>
<li>n</li>
</ul></li>
<li>Where does your code run?
<ul>
<li>Browser</li>
</ul></li>
<li>Which style guide do you want to follow?
<ul>
<li>Use a popular style guide</li>
</ul></li>
<li>Which style guide do you want to follow?
<ul>
<li>Standard: https://github.com/standard/standard</li>
</ul></li>
<li>What format do you want your config file to be in? (Use arrow keys)
<ul>
<li>JavaScript</li>
</ul></li>
<li>Would you like to install them now with npm?
<ul>
<li>y</li>
</ul></li>
</ul>
<p>Now let's start coding, create the file <code>index.js</code> in the folder <code>webapp</code> with the following content:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="st">&#39;ol/ol.css&#39;</span>
<span class="im">import</span> <span class="op">{</span> Map<span class="op">,</span> View <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol&#39;</span>
<span class="im">import</span> OSM <span class="im">from</span> <span class="st">&#39;ol/source/OSM&#39;</span>
<span class="im">import</span> TileLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Tile.js&#39;</span>
<span class="im">import</span> <span class="op">{</span>fromLonLat<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/proj&#39;</span>

<span class="kw">var</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">layers</span><span class="op">:</span> [
    <span class="kw">new</span> <span class="at">TileLayer</span>(<span class="op">{</span>
      <span class="dt">source</span><span class="op">:</span> <span class="kw">new</span> <span class="at">OSM</span>()
    <span class="op">}</span>)
  ]<span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>The above JavaScript file uses the <a href="https://openlayers.org/en/v6.2.1/apidoc/module-ol_source_OSM-OSM.html"><code>OSM</code></a> class to add the <a href="https://wiki.openstreetmap.org/wiki/Standard_tile_layer">standard OpenStreetMap (OSM) tile layer</a>.</p>
<p>Create the file <code>index.html</code> in the folder <code>webapp</code> with the following content:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>

<span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;title&gt;</span>PDOK Webservices<span class="kw">&lt;/title&gt;</span>
    <span class="kw">&lt;style&gt;</span>
        html,
        body {
            <span class="kw">height</span>: <span class="dv">100%</span>;
            <span class="kw">margin</span>: <span class="dv">0px</span>;
        }

        <span class="pp">#map</span> {
            <span class="kw">height</span>: <span class="dv">100%</span>;
        }
    <span class="kw">&lt;/style&gt;</span>
<span class="kw">&lt;/head&gt;</span>

<span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;map&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;./index.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;/body&gt;</span>

<span class="kw">&lt;/html&gt;</span></code></pre></div>
<p>Replace the empty <code>scripts</code> element in the <code>webapp/package.json</code> file with the following:</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span>
    <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;echo </span><span class="ch">\&quot;</span><span class="st">Error: no test specified</span><span class="ch">\&quot;</span><span class="st"> &amp;&amp; exit 1&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;parcel index.html&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="st">&quot;parcel build --public-url . index.html&quot;</span>
<span class="fu">}</span></code></pre></div>
<p>No run the following command from the <code>webapp/</code> directory:</p>
<pre><code>npm start</code></pre>
<p>Visit <a href="http://localhost:1234/"><code>http://localhost:1234/</code></a> to view the results. If correct you should see a interactive map in your browser with the default OpenLayers basemap.</p>
<div class="figure">
<img src="images/viewer_step1.png" title="First map!" alt="First map!" />
<p class="caption">First map!</p>
</div>
<h2 id="adding-base-map-to-viewer">2. Adding base map to viewer</h2>
<blockquote>
<p>TODO: Summary of section.</p>
</blockquote>
<p>Replace the code in <code>viewer/index.js</code> with the following:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="st">&#39;ol/ol.css&#39;</span>
<span class="im">import</span> <span class="op">{</span> Map<span class="op">,</span> View <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol&#39;</span>
<span class="im">import</span> WMTSSource <span class="im">from</span> <span class="st">&#39;ol/source/WMTS&#39;</span>
<span class="im">import</span> TileLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Tile.js&#39;</span>
<span class="im">import</span> WMTSTileGrid <span class="im">from</span> <span class="st">&#39;ol/tilegrid/WMTS.js&#39;</span>
<span class="im">import</span> <span class="op">{</span> get <span class="im">as</span> getProjection<span class="op">,</span> fromLonLat <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/proj&#39;</span>
<span class="im">import</span> <span class="op">{</span> getTopLeft<span class="op">,</span> getWidth <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/extent.js&#39;</span>

<span class="kw">const</span> projection <span class="op">=</span> <span class="at">getProjection</span>(<span class="st">&#39;EPSG:3857&#39;</span>)
<span class="kw">const</span> projectionExtent <span class="op">=</span> <span class="va">projection</span>.<span class="at">getExtent</span>()
<span class="kw">const</span> size <span class="op">=</span> <span class="at">getWidth</span>(projectionExtent) / <span class="dv">256</span>
<span class="kw">const</span> resolutions <span class="op">=</span> <span class="kw">new</span> <span class="at">Array</span>(<span class="dv">20</span>)
<span class="kw">const</span> matrixIds <span class="op">=</span> <span class="kw">new</span> <span class="at">Array</span>(<span class="dv">20</span>)

<span class="cf">for</span> (<span class="kw">let</span> z <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> z <span class="op">&lt;</span> <span class="dv">20</span><span class="op">;</span> <span class="op">++</span>z) <span class="op">{</span>
  <span class="co">// generate resolutions and matrixIds arrays for this WMTS</span>
  <span class="co">// see https://openlayers.org/en/latest/examples/wmts.html</span>
  resolutions[z] <span class="op">=</span> size / <span class="va">Math</span>.<span class="at">pow</span>(<span class="dv">2</span><span class="op">,</span> z)
  matrixIds[z] <span class="op">=</span> z
<span class="op">}</span>

<span class="kw">const</span> baseMapLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">TileLayer</span>(<span class="op">{</span>
  <span class="dt">extent</span><span class="op">:</span> projectionExtent<span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> <span class="kw">new</span> <span class="at">WMTSSource</span>(<span class="op">{</span>
    <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/tiles/service/wmts&#39;</span><span class="op">,</span>
    <span class="dt">layer</span><span class="op">:</span> <span class="st">&#39;brtachtergrondkaartgrijs&#39;</span><span class="op">,</span>
    <span class="dt">matrixSet</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span>
    <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;image/png&#39;</span><span class="op">,</span>
    <span class="dt">attributions</span><span class="op">:</span> <span class="st">&#39;Map data: &lt;a href=&quot;http://www.kadaster.nl&quot;&gt;Kadaster&lt;/a&gt;&#39;</span><span class="op">,</span>
    <span class="dt">tileGrid</span><span class="op">:</span> <span class="kw">new</span> <span class="at">WMTSTileGrid</span>(<span class="op">{</span>
      <span class="dt">origin</span><span class="op">:</span> <span class="at">getTopLeft</span>(projectionExtent)<span class="op">,</span>
      <span class="dt">resolutions</span><span class="op">:</span> resolutions<span class="op">,</span>
      <span class="dt">matrixIds</span><span class="op">:</span> matrixIds
    <span class="op">}</span>)<span class="op">,</span>
    <span class="dt">style</span><span class="op">:</span> <span class="st">&#39;default&#39;</span>
  <span class="op">}</span>)
<span class="op">}</span>)

<span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<div class="figure">
<img src="images/brta.png" title="BRT-Achtergrondkaart" alt="BRT-Achtergrondkaart" />
<p class="caption">BRT-Achtergrondkaart</p>
</div>
<h2 id="adding-wms-to-viewer">3. Adding WMS to viewer</h2>
<blockquote>
<p>TODO: Summary of section.</p>
</blockquote>
<h3 id="adding-wms-layer-to-viewer">3.1 Adding WMS layer to viewer</h3>
<p>Now we have good looking basemap it is time to display something on top of it.</p>
<p><a href="https://www.pdok.nl/introductie/-/article/nationaal-wegen-bestand-nwb-"><em>NWB Wegen</em></a> dataset which is also published as a WMS service. The <em>Geo Services</em> tab provides a <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?request=GetCapabilities&amp;service=wms">WMS service url</a>. The URL provided links to the <code>capabilities</code> document, which describes what the service is capable of. The capabilities document lists which layers, styles, image formats and projections are available and more.</p>
<p>To add the <code>wegvakken</code> layer from the WMS service to the map add the following to the <code>view/index.js</code> document before the declaration of the <code>map</code> object and do not forget to add <code>wsmLayer</code> to the map object. We also need to set the zoomlevel of the initial view to <code>14</code> in order to see the WMS layer. This is due to the way this WMS service is configured, in the capabilities document the <code>wegvakken</code> layer has a <code>MaxScaleDenominator</code> property set to <code>50000</code>. This means that the layer is visible from scale <code>1:1</code> until <code>1:50000</code>. In terms of WMTS zoomlevels this means that layer is visible from zoomlevel <code>14</code> and up.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> ImageLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Image&#39;</span>
<span class="im">import</span> ImageWMS <span class="im">from</span> <span class="st">&#39;ol/source/ImageWMS&#39;</span>

<span class="kw">const</span> wmsSource <span class="op">=</span> <span class="kw">new</span> <span class="at">ImageWMS</span>(<span class="op">{</span>
  <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/nwbwegen/wms?&#39;</span><span class="op">,</span>
  <span class="dt">crossOrigin</span><span class="op">:</span> <span class="st">&#39;anonymous&#39;</span><span class="op">,</span>
  <span class="dt">params</span><span class="op">:</span> <span class="op">{</span> <span class="dt">LAYERS</span><span class="op">:</span> <span class="st">&#39;wegvakken&#39;</span> <span class="op">}</span>
<span class="op">}</span>)

<span class="kw">const</span> wsmLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">ImageLayer</span>(<span class="op">{</span>
  <span class="dt">extent</span><span class="op">:</span> projectionExtent<span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> wmsSource
<span class="op">}</span>)

<span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer<span class="op">,</span>
    wsmLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">14</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>Your map application should now display the <code>wegvakken</code> layer:</p>
<div class="figure">
<img src="images/wms_layer.png" title="WMS layer" alt="WMS layer" />
<p class="caption">WMS layer</p>
</div>
<blockquote>
<p>TODO: explain about scale dependent layer in the WMS, and other disadvantages of the WMS.</p>
</blockquote>
<h3 id="adding-featureinfo-on-click-to-viewer">3.2 Adding featureinfo on click to viewer</h3>
<p>The WMS standard provides a mechanism to retrieve information of features, the underlying vector data of the map. The request do retrieve feature information is called <code>GetFeatureInfo</code>. The WMS specification does not require the implementation of the <code>GetFeatureInfo</code> request, therefore a client should always check in the <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?request=GetCapabilities&amp;service=wms">capabilities document</a> if the service support the <code>GetFeatureInfo</code> request. The NWB wegen WMS supports the <code>GetFeatureInfo</code> request, it is listed in the <code>Capability/Request</code> element in the XML.</p>
<p>In this section we are going to add functionality so show a popup with feature information when a users clicks on the map. To do this add the following to the <code>body</code> element of <code>index.html</code>, before the <code>script.js</code> inclusion:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;popup&quot;</span><span class="ot"> class=</span><span class="st">&quot;ol-popup&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;#&quot;</span><span class="ot"> id=</span><span class="st">&quot;popup-closer&quot;</span><span class="ot"> class=</span><span class="st">&quot;ol-popup-closer&quot;</span><span class="kw">&gt;&lt;/a&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;popup-content&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></div>
<p>Add the following code to <code>index.js</code> before the <code>map</code> constant declaration:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> Overlay <span class="im">from</span> <span class="st">&#39;ol/Overlay&#39;</span>

<span class="co">// Elements that make up the popup.</span>
<span class="kw">var</span> container <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup&#39;</span>)
<span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup-content&#39;</span>)
<span class="kw">var</span> closer <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup-closer&#39;</span>)

<span class="co">// Create an overlay to anchor the popup to the map.</span>
<span class="kw">var</span> overlay <span class="op">=</span> <span class="kw">new</span> <span class="at">Overlay</span>(<span class="op">{</span>
  <span class="dt">element</span><span class="op">:</span> container<span class="op">,</span>
  <span class="dt">autoPan</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="dt">autoPanAnimation</span><span class="op">:</span> <span class="op">{</span>
    <span class="dt">duration</span><span class="op">:</span> <span class="dv">250</span>
  <span class="op">}</span>
<span class="op">}</span>)

<span class="co">// Add a click handler to hide the popup.</span>
<span class="va">closer</span>.<span class="at">onclick</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="kw">undefined</span>)
  <span class="va">closer</span>.<span class="at">blur</span>()
  <span class="cf">return</span> <span class="kw">false</span>
<span class="op">}</span></code></pre></div>
<p>Add the <code>overlay</code> const to the <code>map</code> object:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer<span class="op">,</span>
    wsmLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">overlays</span><span class="op">:</span> [overlay]<span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">14</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>Add the <code>singleclick</code> eventhandler on the map object below the <code>map</code> declaration in <code>index.js</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">map</span>.<span class="at">on</span>(<span class="st">&#39;singleclick&#39;</span><span class="op">,</span> <span class="kw">function</span>(evt) <span class="op">{</span>
  <span class="co">// clean content of popup on every new singeclick event</span>
  <span class="cf">if</span> (<span class="va">content</span>.<span class="va">childNodes</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="va">content</span>.<span class="at">childNodes</span>[<span class="dv">0</span>].<span class="at">remove</span>()
  <span class="kw">var</span> viewResolution <span class="op">=</span> <span class="co">/** </span><span class="an">@type</span><span class="co"> {number} */</span> (<span class="va">map</span>.<span class="at">getView</span>().<span class="at">getResolution</span>())<span class="op">;</span>
  <span class="kw">var</span> url <span class="op">=</span> <span class="va">wmsSource</span>.<span class="at">getFeatureInfoUrl</span>(
    <span class="va">evt</span>.<span class="at">coordinate</span><span class="op">,</span> viewResolution<span class="op">,</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span>
    <span class="op">{</span><span class="st">&#39;INFO_FORMAT&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="cf">if</span> (url) <span class="op">{</span>
    <span class="at">fetch</span>(url)
      .<span class="at">then</span>(<span class="kw">function</span> (response) <span class="op">{</span> <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span> <span class="op">}</span>)
      .<span class="at">then</span>(<span class="kw">function</span> (data) <span class="op">{</span>
        <span class="co">// set overlay position to undefined to hide popup</span>
        <span class="cf">if</span> (<span class="va">data</span>.<span class="va">features</span>.<span class="at">length</span> <span class="op">==</span> <span class="dv">0</span>)<span class="op">{</span>
          <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="kw">undefined</span>)
          <span class="cf">return</span>
        <span class="op">}</span>
        <span class="kw">let</span> ft <span class="op">=</span> <span class="va">data</span>.<span class="at">features</span>[<span class="dv">0</span>]
        <span class="kw">let</span> table <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;table&quot;</span>)
        <span class="kw">var</span> header <span class="op">=</span> <span class="va">table</span>.<span class="at">createTHead</span>()
        <span class="kw">var</span> row <span class="op">=</span> <span class="va">header</span>.<span class="at">insertRow</span>()
        <span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span>
        <span class="va">Object</span>.<span class="at">keys</span>(<span class="va">ft</span>.<span class="at">properties</span>).<span class="at">forEach</span>(<span class="kw">function</span>(item)<span class="op">{</span>
          <span class="kw">let</span> cell <span class="op">=</span> <span class="va">row</span>.<span class="at">insertCell</span>(i)
          <span class="va">cell</span>.<span class="at">innerHTML</span> <span class="op">=</span> item
          i<span class="op">++</span>
        <span class="op">}</span>)
        <span class="kw">let</span> body <span class="op">=</span> <span class="va">table</span>.<span class="at">createTBody</span>()
        row <span class="op">=</span> <span class="va">body</span>.<span class="at">insertRow</span>()
        i<span class="op">=</span><span class="dv">0</span>
        <span class="va">Object</span>.<span class="at">keys</span>(<span class="va">ft</span>.<span class="at">properties</span>).<span class="at">forEach</span>(<span class="kw">function</span>(item)<span class="op">{</span>
          <span class="kw">let</span> cell <span class="op">=</span> <span class="va">row</span>.<span class="at">insertCell</span>(i)
          <span class="va">cell</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">ft</span>.<span class="at">properties</span>[item]
          i<span class="op">++</span>
        <span class="op">}</span>)
        <span class="va">content</span>.<span class="at">appendChild</span>(table)
        <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="va">evt</span>.<span class="at">coordinate</span>)
      <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>And add the following CSS to a new <code>index.css</code> file in the root of the <code>webapp</code> folder:</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css">html, body {
    <span class="kw">height</span>: <span class="dv">100%</span>;
    <span class="kw">margin</span>: <span class="dv">0px</span>;
}

<span class="pp">#map</span> {
    <span class="kw">height</span>: <span class="dv">100%</span>;
}

<span class="fu">.ol-popup</span> {
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">background-color</span>: <span class="dv">white</span>;
    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">1px</span> <span class="dv">4px</span> <span class="fu">rgba</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0.2</span>);
    <span class="kw">padding</span>: <span class="dv">15px</span>;
    <span class="kw">border-radius</span>: <span class="dv">10px</span>;
    <span class="kw">border</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#cccccc</span>;
    <span class="kw">bottom</span>: <span class="dv">12px</span>;
    <span class="kw">left</span>: <span class="dv">-50px</span>;
    <span class="kw">min-width</span>: <span class="dv">280px</span>;
    <span class="kw">max-width</span>: <span class="dv">600px</span>;
    <span class="kw">padding-top</span>: <span class="dv">20px</span>;
}

<span class="fu">.ol-popup</span><span class="in">:after</span>, <span class="fu">.ol-popup</span><span class="in">:before</span> {
    <span class="kw">top</span>: <span class="dv">100%</span>;
    <span class="kw">border</span>: <span class="dv">solid</span> <span class="dv">transparent</span>;
    <span class="kw">content</span>: <span class="st">&quot; &quot;</span>;
    <span class="kw">height</span>: <span class="dv">0</span>;
    <span class="kw">width</span>: <span class="dv">0</span>;
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">pointer-events</span>: <span class="dv">none</span>;
}

<span class="fu">.ol-popup</span><span class="in">:after</span> {
    <span class="kw">border-top-color</span>: <span class="dv">white</span>;
    <span class="kw">border-width</span>: <span class="dv">10px</span>;
    <span class="kw">left</span>: <span class="dv">48px</span>;
    <span class="kw">margin-left</span>: <span class="dv">-10px</span>;
}

<span class="fu">.ol-popup</span><span class="in">:before</span> {
    <span class="kw">border-top-color</span>: <span class="dv">#cccccc</span>;
    <span class="kw">border-width</span>: <span class="dv">11px</span>;
    <span class="kw">left</span>: <span class="dv">48px</span>;
    <span class="kw">margin-left</span>: <span class="dv">-11px</span>;
}

<span class="fu">.ol-popup-closer</span> {
    <span class="kw">text-decoration</span>: <span class="dv">none</span>;
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">top</span>: <span class="dv">2px</span>;
    <span class="kw">right</span>: <span class="dv">8px</span>;
}

<span class="fu">.ol-popup-closer</span><span class="in">:visited</span> {
    <span class="kw">text-decoration</span>: <span class="dv">inherit</span>;
    <span class="kw">color</span>: <span class="dv">inherit</span>;
    <span class="kw">cursor</span>: <span class="dv">auto</span>;
}

<span class="fu">.ol-popup-closer</span><span class="in">:after</span> {
    <span class="kw">content</span>: <span class="st">&quot;✖&quot;</span>;
}

<span class="pp">#popup-content</span> {
    <span class="kw">overflow-x</span>: <span class="dv">scroll</span>;
}

table {
    <span class="kw">border</span>: <span class="dv">none</span>;
    <span class="kw">border-collapse</span>: <span class="dv">collapse</span>;
    <span class="kw">font-family</span>: <span class="dv">sans-serif</span>;
}

table td {
    <span class="kw">border-left</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">border-right</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">padding-left</span>: <span class="dv">0.5em</span>;
    <span class="kw">padding-right</span>: <span class="dv">0.5em</span>;
}

thead&gt;tr&gt;td {
    <span class="kw">border-bottom</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">font-weight</span>: <span class="dv">600</span>;
}

table td<span class="in">:first-child</span> {
    <span class="kw">border-left</span>: <span class="dv">none</span>;
}

table td<span class="in">:last-child</span> {
    <span class="kw">border-right</span>: <span class="dv">none</span>;
}

tbody td<span class="in">:nth-of-type</span>(odd), thead td<span class="in">:nth-of-type</span>(odd) {
    <span class="kw">background</span>: <span class="dv">#E6E6E6</span>;
}</code></pre></div>
<p>Remove the <code>style</code> element from the <code>index.html</code> file and replace with:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> type=</span><span class="st">&quot;text/css&quot;</span><span class="ot"> href=</span><span class="st">&quot;index.css&quot;</span><span class="kw">&gt;</span></code></pre></div>
<p>Reload the webapp in the browser,now the map should display a popover when a feature is clicked on the map.</p>
<div class="figure">
<img src="images/get_feature_info.png" title="Feature information" alt="Feature information" />
<p class="caption">Feature information</p>
</div>
<p>What happens in the background is that OpenLayers registers on which pixel coordinate a user clicks. This is information is combined with the query parameters of the previous WMS <code>GetMap</code> request, to create a <code>GetFeatureInfo</code> request. In the below example <code>GetFeatureInfo</code> request the user clicked on pixel coordinate <code>50,50</code> of an image with <code>WIDTH</code> and <code>HEIGHT</code> of <code>101,101</code>, <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetMap&amp;FORMAT=image%2Fpng&amp;TRANSPARENT=true&amp;LAYERS=wegvakken&amp;CRS=EPSG%3A3857&amp;STYLES=&amp;WIDTH=101&amp;HEIGHT=101&amp;BBOX=603781.6790671768%2C6831433.221161786%2C604746.696549277%2C6832398.238643886">this</a> is the corresponding <code>GetMap</code> request.</p>
<pre><code>https://geodata.nationaalgeoregister.nl/nwbwegen/wms?SERVICE=WMS&amp;
VERSION=1.3.0&amp;
REQUEST=GetFeatureInfo&amp;
FORMAT=image%2Fpng&amp;
TRANSPARENT=true&amp;
QUERY_LAYERS=wegvakken&amp;
LAYERS=wegvakken&amp;
INFO_FORMAT=application%2Fjson&amp;
I=50&amp;
J=50&amp;
CRS=EPSG%3A3857&amp;
STYLES=&amp;
WIDTH=101&amp;
HEIGHT=101&amp;
BBOX=603781.6790671768%2C6831433.221161786%2C604746.696549277%2C6832398.238643886</code></pre>
<h2 id="adding-a-geojson-layer-to-your-map">4. Adding a GeoJSON layer to your map</h2>
<blockquote>
<p>TODO: The advantage of using WMS/WMTS services is that you do not have take rendering performance into consideration, that is the job the server.</p>
</blockquote>
<p>A different approach to displaying geographical data is, instead of using WMS and WMTS services, downloading the vector data in the client and displaying the vector data directly. In this scenario there is no need for a server and gives you complete freedom of styling of the data. One major drawback of this approach is performance, processing power on the client is limited; there is a upper limit on the number of features you can load in your map (at once).</p>
<p>When rendering geographical data directly on the client rendering performance is a concern. You can optimize for this by preprocessing your data to either:</p>
<ol style="list-style-type: decimal">
<li>Reduce the size of the dataset by removing features</li>
<li>Reduce the size of the dataset by simplifcation of the geometries (aggregation, generalization)</li>
</ol>
<blockquote>
<p>TODO: include, yes, no? Another technique to improve performance is to load features from the data incrementally into map application, instead all of once. This can be done with the client side vector tile library <a href="https://github.com/mapbox/geojson-vt">geojson-vt</a> JavaScript library.</p>
</blockquote>
<p>In this workshop we only do preprocessing of the data to reduce the size of the dataset. This is done by selecting only the motorways (A wegen) and joining the seperate segments into one geometry grouped by the roadletter and roadnumber combination (for instance group by A1, A2, A348 etcetera). We will use the <code>ogr2ogr</code> commandline utility for data processing.</p>
<h3 id="preprocessing-the-data">4.1 Preprocessing the data</h3>
<p>In this chapter we are going to create a map of the Dutch motor ways, directly rendered in the browser from a GeoJSON file. We will use the <a href="https://www.pdok.nl/introductie/-/article/nationaal-wegen-bestand-nwb-">NWB Wegen dataset</a>, PDOK provides WMS en WFS services and also a direct download service. In this case we will use the PDOK download service, since we want to obtain the full dataset.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> <span class="st">&quot;http://geodata.nationaalgeoregister.nl/nwbwegen/extract/nwbwegen.zip&quot;</span> -o ~/Downloads/nwbwegen.zip
<span class="fu">unzip</span> ~/Downloads/nwbwegen.zip -d ~/Downloads/nwbwegen/ <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> ~/Downloads/nwbwegen.zip</code></pre></div>
<p>Open the Shapefile in QGIS to inspect data from the NWB wegen dataset, Shapefile is located in: <code>~/Downloads/nwbwegen/geogegevens/shapefile/nederland_totaal/wegvakken/wegvakken.shp</code></p>
<div class="figure">
<img src="images/qgis_nwb.png" title="NWB Wegen in QGIS" alt="NWB Wegen in QGIS" />
<p class="caption">NWB Wegen in QGIS</p>
</div>
<p>You will notice that QGIS has a hard time rendering all the features at once when viewing the full extent of the Netherlands. This is a sure sign your browser will have a hard time rendering all this data. To make life easy for the browser we will extract only the motorways froms this dataset.</p>
<p>Another concern is that the roads in the <code>wegvakken</code> layer from NWB-wegen are divided in many seperate segments. This is not ideal for styling and labelling the in the webapplication. Therefore we need to merge the geometries, and we can immediately group them by route-letter and route-number (A2, A10, A348, etcetera).</p>
<p>First step is to convert the shapefile to GPKG and select only the <code>A</code> routes (<a href="https://en.wikipedia.org/wiki/GeoPackage">GeoPackage</a> is the superior geospatial file format, although Shapefile is <a href="https://twitter.com/shapefiie">refusing</a> to go away).</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -f GPKG /tmp/nwb.gpkg ~/Downloads/nwbwegen/geogegevens/shapefile/nederland_totaal/wegvakken/wegvakken.shp -sql <span class="st">&quot;select * from wegvakken where routeltr = &#39;A&#39;&quot;</span> -nln wegvakken_a</code></pre></div>
<p>The add a new column <code>route</code> to the wegvakken table and set the value to <code>routeltr+routenr</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogrinfo</span> /tmp/nwb.gpkg -sql <span class="st">&quot;alter table wegvakken_a add column route TEXT&quot;</span>
<span class="ex">ogrinfo</span> /tmp/nwb.gpkg -sql <span class="st">&quot;update wegvakken_a set route=routeltr||routenr&quot;</span></code></pre></div>
<p>Now you are ready to group the geometries by the newly created <code>route</code> attribute and merge geometries of this group:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -update -f GPKG  /tmp/nwb.gpkg /tmp/nwb.gpkg -sql <span class="st">&quot;SELECT ST_Union(_ogr_geometry_) as geom, route FROM wegvakken_a GROUP BY route&quot;</span> -nln snelwegen -nlt MULTILINESTRING</code></pre></div>
<p>Now convert the snelwegen layer in the GPKG to GeoJSON:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -f GeoJSON snelwegen.json /tmp/nwb.gpkg -sql <span class="st">&quot;select geom, route from snelwegen&quot;</span> -t_srs EPSG:3857 -nln snelwegen</code></pre></div>
<p>Open <code>snelwegen.json</code> in QGIS, to verify whether you see the expected output, compare it with the intermediate layers in <code>/tmp/nwb.gpkg</code>. You can style the layer based on the <code>route</code> attribute:</p>
<div class="figure">
<img src="images/qgis_snelwegen.png" title="Snelwegen in QGIS" alt="Snelwegen in QGIS" />
<p class="caption">Snelwegen in QGIS</p>
</div>
<p>Then copy the <code>snelwegen.json</code> file to the <code>webapp</code> folder.</p>
<h3 id="adding-a-geojson-layer-to-the-map">4.2 Adding a GeoJSON layer to the map</h3>
<p>Next we need to add some imports to the <code>index.js</code> file to display the GeoJSON file in your webapp:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> Point <span class="im">from</span> <span class="st">&#39;ol/geom/Point&#39;</span>
<span class="im">import</span> <span class="op">{</span> Text<span class="op">,</span> Fill<span class="op">,</span> Stroke<span class="op">,</span> Style <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/style&#39;</span>
<span class="im">import</span> MultiLineString <span class="im">from</span> <span class="st">&#39;ol/geom/MultiLineString&#39;</span>
<span class="im">import</span> VectorLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Vector&#39;</span>
<span class="im">import</span> <span class="op">{</span> Vector <span class="im">as</span> VectorSource <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/source&#39;</span>
<span class="im">import</span> GeoJSON <span class="im">from</span> <span class="st">&#39;ol/format/GeoJSON&#39;</span></code></pre></div>
<p>Remove the WMS layer and the click event handler, we are going to replace these with the GeoJSON layer.</p>
<p>Add the following to <code>index.js</code> and do not forget to add the <code>snelwegenLayer</code> to the <code>map</code> object:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">styleFunc</span> (feature) <span class="op">{</span>
  <span class="kw">const</span> styles <span class="op">=</span> [
    <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">5</span>
      <span class="op">}</span>)
    <span class="op">}</span>)<span class="op">,</span>
    <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span>
      <span class="op">}</span>)
    <span class="op">}</span>)
  ]
  <span class="va">styles</span>.<span class="at">push</span>(<span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
    <span class="dt">geometry</span><span class="op">:</span> <span class="kw">function</span> (feature) <span class="op">{</span>
      <span class="kw">var</span> multiLineString <span class="op">=</span> <span class="kw">new</span> <span class="at">MultiLineString</span>(<span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getCoordinates</span>())
      <span class="co">// labelPoint is the closest point on the line from the center of the extent of the geometry</span>
      <span class="kw">var</span> labelPoint <span class="op">=</span> <span class="va">multiLineString</span>.<span class="at">getClosestPoint</span>(<span class="at">getCenter</span>(<span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getExtent</span>()))
      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Point</span>(labelPoint)
    <span class="op">},</span>
    <span class="dt">text</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Text</span>(<span class="op">{</span>
      <span class="dt">text</span><span class="op">:</span> <span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>)<span class="op">,</span>
      <span class="dt">font</span><span class="op">:</span> <span class="st">&#39;1em sans-serif&#39;</span><span class="op">,</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">6</span>
      <span class="op">}</span>)<span class="op">,</span>
      <span class="dt">fill</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Fill</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span>
      <span class="op">}</span>)<span class="op">,</span>
      <span class="dt">overflow</span><span class="op">:</span> <span class="kw">true</span>
    <span class="op">}</span>)
  <span class="op">}</span>))
  <span class="cf">return</span> styles
<span class="op">};</span>

<span class="kw">const</span> snelwegenSource <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorSource</span>(<span class="op">{</span>
  <span class="dt">features</span><span class="op">:</span> (<span class="kw">new</span> <span class="at">GeoJSON</span>(
  )).<span class="at">readFeatures</span>(snelwegen)
<span class="op">}</span>)

<span class="kw">const</span> snelwegenLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">source</span><span class="op">:</span> snelwegenSource<span class="op">,</span>
  <span class="dt">style</span><span class="op">:</span> styleFunc<span class="op">,</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)</code></pre></div>
<p>Refresh your browser to see the result:</p>
<div class="figure">
<img src="images/geojson_layer.png" title="GeoJSON layer" alt="GeoJSON layer" />
<p class="caption">GeoJSON layer</p>
</div>
<p>With a simple modification of the style function the labelling can be made dynamic, based on the exent of the current view, this way all features in the current view are labelled:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> labelPoint <span class="op">=</span> <span class="va">multiLineString</span>.<span class="at">getClosestPoint</span>(<span class="at">getCenter</span>(<span class="va">map</span>.<span class="at">getView</span>().<span class="at">calculateExtent</span>(<span class="va">map</span>.<span class="at">getSize</span>())))</code></pre></div>
<p>However this is not an ideal solution either due to the jumping labels on every zoomchange.</p>
<blockquote>
<p>TODO: This can off course also be solved, but as you may realise labelling is hard a problem.</p>
</blockquote>
<p>Since we have the actual vector data loaded in the viewer, it is fairly easy to highlight selected features. Add the following to <code>index.js</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> selection <span class="op">=</span> <span class="op">{}</span>

<span class="kw">const</span> selectionLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> <span class="va">snelwegenLayer</span>.<span class="at">getSource</span>()<span class="op">,</span>
  <span class="dt">style</span><span class="op">:</span> <span class="kw">function</span> (feature) <span class="op">{</span>
    <span class="cf">if</span> (<span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>) <span class="kw">in</span> selection) <span class="op">{</span>
      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
        <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
          <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span>
          <span class="dt">width</span><span class="op">:</span> <span class="fl">1.5</span>
        <span class="op">}</span>)
      <span class="op">}</span>)
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>)

<span class="va">map</span>.<span class="at">on</span>([<span class="st">&#39;click&#39;</span>]<span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>
  <span class="kw">const</span> features <span class="op">=</span> <span class="va">map</span>.<span class="at">getFeaturesAtPixel</span>(<span class="va">event</span>.<span class="at">pixel</span><span class="op">,</span> <span class="op">{</span> <span class="dt">hitTolerance</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)
  <span class="cf">if</span> (<span class="op">!</span><span class="va">features</span>.<span class="at">length</span>) <span class="op">{</span>
    selection <span class="op">=</span> <span class="op">{}</span>
    <span class="va">selectionLayer</span>.<span class="at">changed</span>()
    <span class="cf">return</span>
  <span class="op">}</span>
  <span class="kw">const</span> feature <span class="op">=</span> features[<span class="va">features</span>.<span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]
  <span class="kw">const</span> identifier <span class="op">=</span> <span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>)
  selection <span class="op">=</span> <span class="op">{}</span>
  selection[identifier] <span class="op">=</span> feature
  <span class="va">selectionLayer</span>.<span class="at">changed</span>()
<span class="op">}</span>)</code></pre></div>
<p>Do not forget to add the new <code>selectionLayer</code> to the map. Now when a feature on the map is clicked it will be highlighted.</p>
<div class="figure">
<img src="images/geojson_highlight.png" title="GeoJSON highlight" alt="GeoJSON highlight" />
<p class="caption">GeoJSON highlight</p>
</div>
<h2 id="using-the-pdok-location-server">5. Using the PDOK Location Server</h2>
<blockquote>
<p>TODO: Introduction about the location server, or maybe in the general introduction</p>
</blockquote>
<h3 id="adding-a-custom-control-to-the-map">5.1 Adding a custom control to the map</h3>
<p>See docs here: https://github.com/PDOK/locatieserver/wiki/API-Locatieserver</p>
<ol style="list-style-type: decimal">
<li>Install autocomplete npm dependency: <code>npm install autocompleter</code></li>
<li>Remove <code>popup</code> html elements from <code>index.html</code></li>
<li>Add css to <code>index.css</code>:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fu">.ol-zoom.ol-control</span>{
  <span class="kw">top</span>: <span class="dv">2em</span>;
}</code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Add js:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> Control <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/control&#39;</span>
<span class="im">import</span> WKT <span class="im">from</span> <span class="st">&#39;ol/format/WKT&#39;</span>
<span class="im">import</span> autocomplete <span class="im">from</span> <span class="st">&#39;autocompleter&#39;</span>
<span class="im">import</span> <span class="st">&#39;autocompleter/autocomplete.css&#39;</span>

<span class="kw">const</span> locatieServerUrl <span class="op">=</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/locatieserver/v3&#39;</span>

<span class="kw">var</span> LocationServerControl <span class="op">=</span> <span class="co">/* @__PURE__ */</span>(<span class="kw">function</span> (Control) <span class="op">{</span>
  <span class="kw">function</span> <span class="at">LocationServerControl</span> (optOptions) <span class="op">{</span>
    <span class="kw">var</span> options <span class="op">=</span> optOptions <span class="op">||</span> <span class="op">{}</span>
    <span class="kw">var</span> input <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&#39;input&#39;</span>)
    <span class="va">input</span>.<span class="at">id</span> <span class="op">=</span> <span class="st">&#39;input-loc&#39;</span>
    <span class="kw">var</span> element <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&#39;div&#39;</span>)
    <span class="va">element</span>.<span class="at">className</span> <span class="op">=</span> <span class="st">&#39;input-loc ol-unselectable ol-control&#39;</span>
    <span class="va">element</span>.<span class="at">appendChild</span>(input)
    <span class="va">Control</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="op">{</span>
      <span class="dt">element</span><span class="op">:</span> element<span class="op">,</span>
      <span class="dt">target</span><span class="op">:</span> <span class="va">options</span>.<span class="at">target</span>
    <span class="op">}</span>)
  <span class="op">}</span>
  <span class="cf">if</span> (Control) <span class="va">LocationServerControl</span>.<span class="at">__proto__</span> <span class="op">=</span> Control <span class="co">// eslint-disable-no-proto</span>
  <span class="va">LocationServerControl</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(Control <span class="op">&amp;&amp;</span> <span class="va">Control</span>.<span class="at">prototype</span>)
  <span class="va">LocationServerControl</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> LocationServerControl
  <span class="cf">return</span> LocationServerControl
<span class="op">}</span>(Control))

<span class="va">map</span>.<span class="at">addControl</span>(<span class="kw">new</span> <span class="at">LocationServerControl</span>())</code></pre></div>
<h3 id="retrieve-suggestions-from-locatie-server">5.2 Retrieve suggestions from Locatie Server</h3>
<ol start="6" style="list-style-type: decimal">
<li>add autocomplete:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="at">autocomplete</span>(<span class="op">{</span>
      <span class="dt">input</span><span class="op">:</span> input<span class="op">,</span>
      <span class="dt">fetch</span><span class="op">:</span> <span class="kw">function</span> (text<span class="op">,</span> update) <span class="op">{</span>
        <span class="at">fetch</span>(<span class="vs">`</span><span class="sc">${</span>locatieServerUrl<span class="sc">}</span><span class="vs">/suggest?q=</span><span class="sc">${</span>text<span class="sc">}</span><span class="vs">`</span>)
          .<span class="at">then</span>((response) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()
          <span class="op">}</span>)
          .<span class="at">then</span>((data) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">const</span> suggestions <span class="op">=</span> []
            <span class="va">data</span>.<span class="va">response</span>.<span class="va">docs</span>.<span class="at">forEach</span>(<span class="kw">function</span> (item) <span class="op">{</span>
              <span class="kw">const</span> name <span class="op">=</span> <span class="va">item</span>.<span class="at">weergavenaam</span>
              <span class="kw">const</span> id <span class="op">=</span> <span class="va">item</span>.<span class="at">id</span>
              <span class="va">suggestions</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">label</span><span class="op">:</span> name<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> id <span class="op">}</span>)
            <span class="op">}</span>)
            <span class="at">update</span>(suggestions)
          <span class="op">}</span>)
      <span class="op">}</span>
    <span class="op">}</span>)</code></pre></div>
<h3 id="retrieve-selected-object-from-locatie-server">5.3 Retrieve selected object from Locatie Server</h3>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">onSelect<span class="op">:</span> <span class="kw">function</span> (item) <span class="op">{</span>
        <span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> <span class="va">item</span>.<span class="at">label</span>
        <span class="kw">const</span> id <span class="op">=</span> <span class="va">item</span>.<span class="at">value</span>
        <span class="at">fetch</span>(<span class="vs">`</span><span class="sc">${</span>locatieServerUrl<span class="sc">}</span><span class="vs">/lookup?id=</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">&amp;fl=id,geometrie_ll`</span>)
          .<span class="at">then</span>((response) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()
          <span class="op">}</span>)
          .<span class="at">then</span>((data) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">const</span> wktLoc <span class="op">=</span> <span class="va">data</span>.<span class="va">response</span>.<span class="at">docs</span>[<span class="dv">0</span>].<span class="at">geometrie_ll</span>
            <span class="kw">const</span> format <span class="op">=</span> <span class="kw">new</span> <span class="at">WKT</span>()
            <span class="kw">const</span> feature <span class="op">=</span> <span class="va">format</span>.<span class="at">readFeature</span>(wktLoc<span class="op">,</span> <span class="op">{</span>
              <span class="dt">dataProjection</span><span class="op">:</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">,</span>
              <span class="dt">featureProjection</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span>
            <span class="op">}</span>)
            <span class="kw">const</span> ext <span class="op">=</span> <span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getExtent</span>()
            <span class="va">map</span>.<span class="at">getView</span>().<span class="at">fit</span>(ext<span class="op">,</span> <span class="va">map</span>.<span class="at">getSize</span>())
          <span class="op">}</span>)
      <span class="op">}</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>As you can see, the <code>lookup</code> endpoint returns a geometry of the requested object. You can make this geometry visible by creating a <code>VectorSource</code> and <code>VectorLayer</code>, add the feature to the <code>VectorSource</code> and add the <code>VectorLayer</code> to the map.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> vectorSource <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorSource</span>()

<span class="kw">const</span> vectorLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">source</span><span class="op">:</span> vectorSource<span class="op">,</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)</code></pre></div>
<p>In the promise fulfillment of the <code>lookup</code> fetch add after creating the feature form WKT:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">vectorSource</span>.<span class="at">clear</span>()
<span class="va">vectorSource</span>.<span class="at">addFeature</span>(feature)</code></pre></div>
<h1 id="referenties">Referenties</h1>
<ul>
<li><a href="https://docs.geostandaarden.nl/wp/wpgs/">GeoNovum Whitepaper Geo-standaarden</a></li>
<li><a href="https://en.wikipedia.org/wiki/Open_Geospatial_Consortium">Open Geospatial Consortium (OGC)</a></li>
<li></li>
</ul>
</body>
</html>
