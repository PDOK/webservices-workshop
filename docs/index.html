<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>PDOK Webservices Workshop</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="pandoc.css" type="text/css" />
  <script type="text/javascript" src="http://livejs.com/live.js"></script>
  <style>.caption{font-style:italic;}</style>
  <link href="https://www.pdok.nl/o/iv-pdok-theme/images/favicon.ico" rel="icon" />
</head>
<body>
<div id="header">
<h1 class="title">PDOK Webservices Workshop</h1>
</div>
<!-- TITLE: PDOK Webservices Workshop -->
<div style="background-color:#1A1E4F;padding:1em; border-radius: 3px;">
<p><a href="https://pdok.nl"><img src="images/pdok_logo.png" title="PDOK Logo" alt="PDOK Logo" /></a></p>
</div>
<!-- TOC -->
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#pdok-and-webservices">PDOK and Webservices</a>
<ul>
<li><a href="#finding-and-discovery-service">Finding and Discovery Service</a>
<ul>
<li><a href="#pdok-website">PDOK website</a></li>
<li><a href="#pdok-viewer">PDOK viewer</a></li>
<li><a href="#pdok-services-plugin-qgis">PDOK Services Plugin QGIS</a></li>
<li><a href="#nationaalgeoregister">Nationaalgeoregister</a></li>
</ul></li>
<li><a href="#ogc-web-services-ows">OGC Web Services (OWS)</a></li>
<li><a href="#web-map-service-wms">Web Map Service (WMS)</a></li>
<li><a href="#web-map-tile-service-wmts">Web Map Tile Service (WMTS)</a></li>
<li><a href="#web-feature-service-wfs">Web Feature Service (WFS)</a></li>
<li><a href="#catalogue-service-for-the-web-csw">Catalogue Service for the Web (CSW)</a></li>
</ul></li>
<li><a href="#workshop">Workshop</a>
<ul>
<li><a href="#setting-up-npm-project-with-openlayers">Setting up NPM Project with OpenLayers</a>
<ul>
<li><a href="#install-dependencies-and-setup-eslint">Install dependencies and setup ESLint</a></li>
<li><a href="#first-web-map-with-openlayers">First web map with OpenLayers</a></li>
</ul></li>
<li><a href="#adding-base-map-layer">Adding Base Map Layer</a></li>
<li><a href="#adding-wms-layer">Adding WMS Layer</a>
<ul>
<li><a href="#adding-wms-layer-to-viewer">Adding WMS Layer to Viewer</a></li>
<li><a href="#adding-featureinfo-on-click-to-viewer">Adding Featureinfo on Click to Viewer</a></li>
</ul></li>
<li><a href="#adding-a-geojson-layer">Adding a GeoJSON Layer</a>
<ul>
<li><a href="#data-preprocessing">Data Preprocessing</a></li>
<li><a href="#adding-geojson-as-a-layer">Adding GeoJSON as a Layer</a></li>
</ul></li>
<li><a href="#using-the-pdok-location-server">Using the PDOK Location Server</a>
<ul>
<li><a href="#adding-custom-control">Adding Custom Control</a></li>
<li><a href="#get-suggestions-from-locatie-server">Get Suggestions from Locatie Server</a></li>
<li><a href="#get-result-from-locatie-server">Get Result from Locatie Server</a></li>
</ul></li>
</ul></li>
</ul>
<!-- /TOC -->
<p><a id="markdown-introduction" name="introduction"></a></p>
<h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<blockquote>
<p>A VirtualBox image has been prepared with all the required software for this workshop pre-installed. You can download it <a href="https://www.dropbox.com/sh/6j3e40thy9pspoi/AACS2NCHaT0h8JbKLTDSpZx9a">here</a>.</p>
</blockquote>
<p>In this workshop you will build a web application with an interactive map using the PDOK (map) services. The web application is build with OpenLayers version 6.2.1, an Open Source JavaScript library.</p>
<p>While building the web application you will learn the difference between the different geo-service types PDOK is providing, such as WMS, WMTS, WFS and WCS. Chapter <a href="#pdok-and-webservices">PDOK and Webservices</a> provides a general introduction on PDOK and the different webservices.</p>
<p>If you want to dive head first in the hands-on part of the workshop go immediately to the <a href="#workshop">workshop</a>.</p>
<p><a id="markdown-pdok-and-webservices" name="pdok-and-webservices"></a></p>
<h1 id="pdok-and-webservices"><span class="header-section-number">2</span> PDOK and Webservices</h1>
<p><a href="https://www.pdok.nl/">Publieke Dienstverlening op de Kaart</a> (PDOK) is the geographical open data platform of the Dutch government. PDOK provides geo web services for many Dutch governmental organizations, for instance Kadaster, CBS, RIVM, Rijkswaterstaat and many more.</p>
<p>Due to the <a href="https://www.digitaleoverheid.nl/overzicht-van-alle-onderwerpen/standaardisatie/open-standaarden/">open standards policy</a> of the Dutch government, PDOK is using many open standards. Open standard contribute to interoperability and prevent vendor lock-in, this is important since many of the users of the PDOK services are governmental organizations themselves.</p>
<p>Many of the standards used by PDOK concern the web service interfaces, but PDOK also uses a range of different file format standards. For instance for how data providers need to encode their data for delivering to PDOK. Most of these standards are specific for the geographical domain and originate from the <a href="https://en.wikipedia.org/wiki/Open_Geospatial_Consortium">Open GeoSpatial Consortium</a> (OGC). The OGC is a non-governmental, industry members organization. Members include big corporations such as Google and ESRI, but also governmental agencies. Members of the OGC cooperate on the development of geospatial open standards. The OGC is very much like the World Wide Web Consortium (W3C), but instead of standards for the web, it makes standards for geospatial.</p>
<p>The traditional standards for geospatial web services are:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Web_Map_Service">Web Map Service</a> (WMS) - serves out maps</li>
<li><a href="https://en.wikipedia.org/wiki/Web_Map_Tile_Service">Web Map Tile Service</a> (WMTS) - serves out map-tiles</li>
<li><a href="https://en.wikipedia.org/wiki/Web_Feature_Service">Web Feature Service</a> (WFS) - serves out vector data (also know as features)</li>
<li><a href="https://en.wikipedia.org/wiki/Web_Coverage_Service">Web Coverage Service</a> (WCS) - serves out raster data (also known as coverages)</li>
<li><a href="https://en.wikipedia.org/wiki/Catalogue_Service_for_the_Web">Catalogue Service for the Web</a> (CSW) - serves out metadata from the catalogue (metadata describes data sets and/or services)</li>
</ul>
<p>PDOK uses all these service standards to make geospatial data accessible over the web. These standards are traditional since these standards are already relatively old (initial release WMS 1999!). The OGC is working hard on developing a new set of standards, based on RESTful principles, with <a href="https://en.wikipedia.org/wiki/OpenAPI_Specification">OpenAPI Specifications</a>, following current best practices. This initiative is called the <a href="https://www.ogc.org/blog/2996">OGC APIs</a>. The development of these standards is work in progress. Also PDOK is involved with the development of this standard by building an OGC API Features <a href="https://github.com/PDOK/wfs-3.0">implementation</a> (formerly known as WFS 3.0).</p>
<p>Another important (relatively new) mapping technology not mentioned yet is vector tiling. This technology has been around for a while, but unfortunately has not been captured yet in one of the OGC standards. Today everybody pretty much does what Mapbox does, since Mapbox developed most of this technology. Mapbox did publish the <a href="https://github.com/mapbox/vector-tile-spec">Mapbox Vector Tile Specification</a> as an open standard and considering the widespread use we can say that it is a <em>de facto</em> standard. However it lacks the authority of the OGC to make it a <em>de jure</em> standard, which in the context of PDOK and the open standards policy of the Dutch government is deemed quite important. Mapbox <a href="https://docs.mapbox.com/vector-tiles/reference/">provides</a> an excellent introduction on vector tiles. Main advantage of using vector tiles is that it provides a superior user experience, since it allows for dynamic styling and improved interaction with the objects on the map, since vector tiles contain the actual <a href="https://en.wikipedia.org/wiki/Geographical_feature#Cartographic_features">feature</a> data.</p>
<p><a id="markdown-finding-and-discovery-service" name="finding-and-discovery-service"></a></p>
<h2 id="finding-and-discovery-service"><span class="header-section-number">2.1</span> Finding and Discovery Service</h2>
<p>So PDOK hosts many services that publish geographic data, but how does one find the right data set and services? There are a number of different ways to go about it:</p>
<p><a id="markdown-pdok-website" name="pdok-website"></a></p>
<h3 id="pdok-website"><span class="header-section-number">2.1.1</span> PDOK website</h3>
<p>PDOK website at <a href="https://www.pdok.nl/datasets">pdok.nl/datasets</a>. Every service PDOK publishes has a data set page on the PDOK website. The data set page contains a description and links to the service endpoints.</p>
<p><a id="markdown-pdok-viewer" name="pdok-viewer"></a></p>
<h3 id="pdok-viewer"><span class="header-section-number">2.1.2</span> PDOK viewer</h3>
<p>PDOK viewer at <a href="https://www.pdok.nl/viewer">pdok.nl/viewer</a>. Almost all services that have a view service (WMS, WMTS, TMS) are listed in the PDOK Viewer. At the moment there is no search functionality in the viewer, so finding the right data set is not so easy.</p>
<p><a id="markdown-pdok-services-plugin-qgis" name="pdok-services-plugin-qgis"></a></p>
<h3 id="pdok-services-plugin-qgis"><span class="header-section-number">2.1.3</span> PDOK Services Plugin QGIS</h3>
<p><a href="https://plugins.qgis.org/plugins/pdokservicesplugin/">PDOK Services Plugin for QGIS</a>. The PDOK Services Plugin for QGIS use the <a href="#nationaalgeoregister-and-catalogue-service-for-the-web-csw">CSW</a> service of the NGR to collect all services PDOK hosts and make them accessible in QGIS. I can highly recommend using this plugin. Plugin is Open Source is not build or maintained by PDOK or Kadaster, but is endorsed, see the source code <a href="https://github.com/rduivenvoorde/pdokservicesplugin">repository</a>. To open the PDOK Services plugin click the orange button in QGIS <img src="images/pdok-plugin.png" title="PDOK Services Plugin" alt="PDOK Services Plugin" />.</p>
<div class="figure">
<img src="images/pdok-plugin-menu.png" title="PDOK Services QGIS Plugin" alt="PDOK Services QGIS Plugin" />
<p class="caption">PDOK Services QGIS Plugin</p>
</div>
<blockquote>
<p><strong>NOTE:</strong> Comes pre-installed on the provided VirtualBox image</p>
</blockquote>
<p><a id="markdown-nationaalgeoregister" name="nationaalgeoregister"></a></p>
<h3 id="nationaalgeoregister"><span class="header-section-number">2.1.4</span> Nationaalgeoregister</h3>
<p><a href="https://nationaalgeoregister.nl/">nationaalgeoregister.nl</a> (NGR) is the Dutch national geo-portal, where open geospatial data sets are published by (mostly) public sector organizations. The NGR also contains data sets and services that are not provided by PDOK. Beside the web-interface NGR also provides API to search the catalogue programmatically, the service protocol of this API is <a href="#catalogue-service-for-the-web-csw">CSW</a>.</p>
<p><a id="markdown-ogc-web-services-ows" name="ogc-web-services-ows"></a></p>
<h2 id="ogc-web-services-ows"><span class="header-section-number">2.2</span> OGC Web Services (OWS)</h2>
<p>The standards in the list of <em>traditional</em> service standards are also known as the OGC Web Services (OWS). In API design these service types are very similar. For instance all service types use XML to exchange message between client and server. Also you can request for each service type a Capabilities document, which describes what that particular service instance is capable of. You can request a Capabilities document by sending a HTTP GET request with the following query parameters:</p>
<pre class="http"><code>service={SERVICE_TYPE}&amp;request=GetCapabilities</code></pre>
<p>For instance for a WMS service the request looks like this:</p>
<pre><code>https://geodata.nationaalgeoregister.nl/cbspostcode4/wms?request=GetCapabilities&amp;service=WMS</code></pre>
<blockquote>
<p>****NOTE:**** Below for each service type a couple of typical requests are listed, this is by no means an exhaustive list of request types in respective specifications!</p>
</blockquote>
<p><a id="markdown-web-map-service-wms" name="web-map-service-wms"></a></p>
<h2 id="web-map-service-wms"><span class="header-section-number">2.3</span> Web Map Service (WMS)</h2>
<p><a href="https://en.wikipedia.org/wiki/Web_Map_Service">WMS</a> is a service protocol for maps; a WMS serves map images rendered from geographical data and styling rules. A WMS does not serve the actual data. WMS supports the following three requests:</p>
<ul>
<li>GetCapabilities: capabilities document describes layer/styles/formats/request</li>
<li>GetFeatureInfo: request feature info for location (optional)</li>
<li>GetMap: request map image
<ul>
<li>request=GetMap</li>
<li>service=WMS</li>
<li>version=1.3.0</li>
<li>layers={comma separated list 1 or more layers}</li>
<li>styles={comma separated list of available layer styling}</li>
<li>crs={coordinate system}</li>
<li>bbox={minx,miny,maxx,maxy}</li>
<li>width={width of the image}</li>
<li>height={height of the image}</li>
<li>format={image format}</li>
</ul></li>
</ul>
<p>Example WMS GetMap HTTP GET request:</p>
<pre class="http"><code>https://geodata.nationaalgeoregister.nl/cbspostcode4/wms?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetMap&amp;FORMAT=image%2Fpng&amp;TRANSPARENT=true&amp;layers=postcode42017&amp;CRS=EPSG%3A28992&amp;STYLES=&amp;WIDTH=2780&amp;HEIGHT=929&amp;BBOX=-937574%2C70963%2C1453670%2C870051</code></pre>
<p>A major disadvantage of the WMS protocol is that in potential every request to server is unique, because of the combination of the extent and the size of the image requested. This makes it impossible in practice to setup a caching layer for a WMS service. Generating map images is a CPU intensive process, response times of multiple seconds are not unheard of.</p>
<p><a id="markdown-web-map-tile-service-wmts" name="web-map-tile-service-wmts"></a></p>
<h2 id="web-map-tile-service-wmts"><span class="header-section-number">2.4</span> Web Map Tile Service (WMTS)</h2>
<p>To overcome the CPU intensive on-the-fly rendering problem, application developers started using pre-rendered map tiles. Several open and proprietary schemes were invented to organize and address these map tiles. An earlier specification for this is the Tile Map Service (TMS).</p>
<p>The concept of map tiles and <a href="https://en.wikipedia.org/wiki/Web_Map_Tile_Service">WMTS</a> is that the zoomlevels are fixed, every zoomlevel is divided in a finite number of tiles. How the zoomlevels are organized is also known as a tilematrix. Most common is the use of a tilematrix piramide, on the lowest zoomlevel (0) 1 (4^0) map tiles and on the highest zoomlevel (22) 17592186044416 (4^22) map tiles. For each zoomlevel deeper, every tile is divided in four. But the WMTS spec does allow for more complex tile matrix sets.</p>
<div class="figure">
<img src="images/tile-matrix.png" title="Tile matrix" alt="Tile matrix" />
<p class="caption">Tile matrix</p>
</div>
<p>WMTS specifies multiple request encoding, but to keep it simple only the key-value-pair encoding (KVP) is shown:</p>
<p>Requests:</p>
<ul>
<li>GetCapabilities: capabilities document</li>
<li>GetFeatureInfo: request feature info for location (optional)</li>
<li>GetTile: request map tile
<ul>
<li>request=GetTile</li>
<li>service=WMTS</li>
<li>version=1.0.0</li>
<li>layer={layer name}</li>
<li>style={layer style}</li>
<li>tilematrixset={tilematrixset}</li>
<li>TileMatrix={zoom level}</li>
<li>TileCol={y coordinate of tile number}</li>
<li>TileRow={x coordinate of tile number}</li>
<li>format={image format}</li>
</ul></li>
</ul>
<p>Example KVP WMTS GetTile HTTP GET request:</p>
<pre class="http"><code>https://geodata.nationaalgeoregister.nl/tiles/service/wmts?layer=brtachtergrondkaart&amp;style=default&amp;tilematrixset=EPSG%3A28992&amp;Service=WMTS&amp;Request=GetTile&amp;Version=1.0.0&amp;Format=image%2Fpng&amp;TileMatrix=02&amp;TileCol=2&amp;TileRow=1</code></pre>
<p><a id="markdown-web-feature-service-wfs" name="web-feature-service-wfs"></a></p>
<h2 id="web-feature-service-wfs"><span class="header-section-number">2.5</span> Web Feature Service (WFS)</h2>
<p><a href="https://en.wikipedia.org/wiki/Web_Feature_Service">WFS</a> is a service protocol that serves <a href="https://en.wikipedia.org/wiki/Geographical_feature#Cartographic_features">features</a>. A WFS is only concerned with vector data, for raster data there is <a href="https://en.wikipedia.org/wiki/Web_Coverage_Service">WCS</a> (Web Coverage Service). Just like a WMS a WFS supports querying the data by extent, but WFS also supports more advanced filtering capabilities, for instance querying on attribute value of the data.</p>
<p>Requests:</p>
<ul>
<li>GetCapabilities: capabilities document</li>
<li>GetFeature: request features
<ul>
<li>service=WFS</li>
<li>request=GetFeature</li>
<li>version=2.0.0</li>
<li>typename={featuretype name}</li>
<li>startindex={paging start}</li>
<li>count={number of records to return}</li>
<li>srsname={projection of returned data}</li>
<li>outputFormat={request outputformat, capabilities doc list supported formats}</li>
</ul></li>
</ul>
<p>Example WFS GetFeature HTTP GET request:</p>
<pre class="http"><code>http://geodata.nationaalgeoregister.nl/cbspostcode4/wfs?SERVICE=WFS&amp;REQUEST=GetFeature&amp;VERSION=2.0.0&amp;TYPENAME=cbspostcode4:postcode42017&amp;STARTINDEX=0&amp;COUNT=200&amp;SRSNAME=urn:ogc:def:crs:EPSG::28992&amp;outputFormat=application/json</code></pre>
<p><a id="markdown-catalogue-service-for-the-web-csw" name="catalogue-service-for-the-web-csw"></a></p>
<h2 id="catalogue-service-for-the-web-csw"><span class="header-section-number">2.6</span> Catalogue Service for the Web (CSW)</h2>
<p><a href="https://en.wikipedia.org/wiki/Catalogue_Service_for_the_Web">CSW</a> is a protocol to make metadata records on geospatial resources (such as data sets and services) searchable. The word catalogue in CSW is the catalogue of metadata records. The Dutch national geo-portal is <a href="https://nationaalgeoregister.nl/">nationaalgeoregister.nl</a> (NGR). Almost all open geospatial data that are published by governmental organizations are registered in the NGR. NGR also provides a CSW endpoint, which can be used to query the catalogue programmatically.</p>
<p>An example CSW GetRecords HTTP GET request:</p>
<pre class="http"><code>https://www.nationaalgeoregister.nl/geonetwork/srv/dut/csw?request=GetRecords&amp;Service=CSW&amp;Version=2.0.2&amp;typeNames=gmd:MD_Metadata&amp;constraint=keyword=%27defensie%27&amp;constraintLanguage=CQL_TEXT&amp;constraint_language_version=1.1.0&amp;resultType=results</code></pre>
<p><a id="markdown-workshop" name="workshop"></a></p>
<h1 id="workshop"><span class="header-section-number">3</span> Workshop</h1>
<p>Before you begin with the workshop it is highly recommended to update this repository by running:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> pull</code></pre></div>
<p>The workshop is divided in five sections, each sections builds on the previous section. This repository contains five sections branches, which holds a working example application for each section:</p>
<ul>
<li>section-1: <a href="#setting-up-npm-project-with-openlayers">Setting up NPM Project with OpenLayers</a></li>
<li>section-2: <a href="#adding-base-map-layer">Adding Base Map Layer</a></li>
<li>section-3: <a href="#adding-wms-layer">Adding WMS Layer</a></li>
<li>section-4: <a href="#adding-a-geojson-layer">Adding a GeoJSON Layer</a></li>
<li>section-5: <a href="#using-the-pdok-location-server">Using the PDOK Location Server</a></li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> All created applications in this workshop will use the cartographic projection <a href="https://en.wikipedia.org/wiki/Web_Mercator_projection"><em>Web Mercator</em></a> <code>EPSG:3857</code>. This is the <em>de facto</em> standard in map projections for web mapping applications. Governmental organizations in the Netherlands often require the use of the <a href="https://nl.wikipedia.org/wiki/Rijksdriehoeksco%C3%B6rdinaten"><em>Amersfoort/RD New</em></a> <code>EPSG:28992</code> projection, some the map services of PDOK are only available in the <em>Amersfoort/RD New</em> projection. More information about map projections can be found on <a href="https://en.wikipedia.org/wiki/Map_projection">Wikipedia</a>.</p>
</blockquote>
<p>q <a id="markdown-setting-up-npm-project-with-openlayers" name="setting-up-npm-project-with-openlayers"></a></p>
<h2 id="setting-up-npm-project-with-openlayers"><span class="header-section-number">3.1</span> Setting up NPM Project with OpenLayers</h2>
<p><a id="markdown-install-dependencies-and-setup-eslint" name="install-dependencies-and-setup-eslint"></a></p>
<h3 id="install-dependencies-and-setup-eslint"><span class="header-section-number">3.1.1</span> Install dependencies and setup ESLint</h3>
<p>First start by modifying your profiles path in the Bash shell, edit the file <code>~/.profile</code> and add the following line:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">export</span> <span class="va">PATH=</span>./node_modules/.bin:<span class="va">$PATH</span></code></pre></div>
<p>Next make sure you load the changes in your profile by sourcing the profile file:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">source</span> ~/.profile</code></pre></div>
<p>Then run the following commands from the root of this repository:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> webapp <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> webapp
<span class="ex">npm</span> init -y
<span class="ex">npm</span> install ol
<span class="ex">npm</span> install --save-dev parcel-bundler eslint</code></pre></div>
<p>Setting up a linter helps with detecting syntax errors and conforming to a particular style guide. This workshop uses ESLint a JavaScript linter, setup ESLint by running <code>eslinit --init</code> and answer questions with:</p>
<ul>
<li>How would you like to use ESLint?
<ul>
<li>To check syntax, find problems, and enforce code style</li>
</ul></li>
<li>What type of modules does your project use? (Use arrow keys)
<ul>
<li>JavaScript modules (import/export)</li>
</ul></li>
<li>Which framework does your project use?
<ul>
<li>None of these</li>
</ul></li>
<li>Does your project use TypeScript?
<ul>
<li>n</li>
</ul></li>
<li>Where does your code run?
<ul>
<li>Browser</li>
</ul></li>
<li>Which style guide do you want to follow?
<ul>
<li>Use a popular style guide</li>
</ul></li>
<li>Which style guide do you want to follow?
<ul>
<li>Standard: https://github.com/standard/standard</li>
</ul></li>
<li>What format do you want your config file to be in? (Use arrow keys)
<ul>
<li>JavaScript</li>
</ul></li>
<li>Would you like to install them now with npm?
<ul>
<li>y</li>
</ul></li>
</ul>
<p>To setup ESLint in VS Code, install the <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">ESLint extension</a> for VS Code. Then add the following to your VS Code preferences in <code>settings.json</code> (through <code>File&gt;Preferences</code> then click icon in upper right corner to show the actual JSON):</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="st">&quot;editor.codeActionsOnSave&quot;</span><span class="op">:</span> <span class="op">{</span>
  <span class="st">&quot;source.fixAll&quot;</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">},</span>
<span class="st">&quot;eslint.workingDirectories&quot;</span><span class="op">:</span> [ <span class="st">&quot;./webapp&quot;</span> ]</code></pre></div>
<p>This will make sure ESLint will run on save and detect the <code>webapp</code> directory as a working directory.</p>
<p><a id="markdown-first-web-map-with-openlayers" name="first-web-map-with-openlayers"></a></p>
<h3 id="first-web-map-with-openlayers"><span class="header-section-number">3.1.2</span> First web map with OpenLayers</h3>
<p>Now let's start coding, create the file <code>index.js</code> in the folder <code>webapp</code> with the following content:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="st">&#39;ol/ol.css&#39;</span>
<span class="im">import</span> <span class="op">{</span> Map<span class="op">,</span> View <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol&#39;</span>
<span class="im">import</span> OSM <span class="im">from</span> <span class="st">&#39;ol/source/OSM&#39;</span>
<span class="im">import</span> TileLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Tile.js&#39;</span>
<span class="im">import</span> <span class="op">{</span>fromLonLat<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/proj&#39;</span>

<span class="kw">var</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">layers</span><span class="op">:</span> [
    <span class="kw">new</span> <span class="at">TileLayer</span>(<span class="op">{</span>
      <span class="dt">source</span><span class="op">:</span> <span class="kw">new</span> <span class="at">OSM</span>()
    <span class="op">}</span>)
  ]<span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>The above JavaScript file uses the <a href="https://openlayers.org/en/v6.2.1/apidoc/module-ol_source_OSM-OSM.html"><code>OSM</code></a> class to add the <a href="https://wiki.openstreetmap.org/wiki/Standard_tile_layer">standard OpenStreetMap (OSM) tile layer</a>.</p>
<p>Create the file <code>index.html</code> in the folder <code>webapp</code> with the following content:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>

<span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;title&gt;</span>PDOK Webservices<span class="kw">&lt;/title&gt;</span>
    <span class="kw">&lt;style&gt;</span>
        html,
        body {
            <span class="kw">height</span>: <span class="dv">100%</span>;
            <span class="kw">margin</span>: <span class="dv">0px</span>;
        }

        <span class="pp">#map</span> {
            <span class="kw">height</span>: <span class="dv">100%</span>;
        }
    <span class="kw">&lt;/style&gt;</span>
<span class="kw">&lt;/head&gt;</span>

<span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;map&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;./index.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;/body&gt;</span>

<span class="kw">&lt;/html&gt;</span></code></pre></div>
<p>Replace the <code>scripts</code> element in the <code>webapp/package.json</code> file with the following:</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span>
    <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;echo </span><span class="ch">\&quot;</span><span class="st">Error: no test specified</span><span class="ch">\&quot;</span><span class="st"> &amp;&amp; exit 1&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;parcel index.html&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="st">&quot;parcel build --public-url . index.html&quot;</span>
<span class="fu">}</span></code></pre></div>
<p>Now run the following command from the <code>webapp/</code> directory:</p>
<pre class="npm"><code>npm start</code></pre>
<p>Visit <a href="http://localhost:1234/"><code>http://localhost:1234/</code></a> to view the glorious result. If correct you should see a interactive map in your browser with the default OpenLayers basemap.</p>
<div class="figure">
<img src="images/viewer_step1.png" title="First map!" alt="First map!" />
<p class="caption">First map!</p>
</div>
<p><a id="markdown-adding-base-map-layer" name="adding-base-map-layer"></a></p>
<h2 id="adding-base-map-layer"><span class="header-section-number">3.2</span> Adding Base Map Layer</h2>
<p>Now you are going to add a <a href="#web-map-tile-service-wmts">WMTS</a> layer to your map as basemap layer.</p>
<p>Replace the code in <code>index.js</code> with the following:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="st">&#39;ol/ol.css&#39;</span>
<span class="im">import</span> <span class="op">{</span> Map<span class="op">,</span> View <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol&#39;</span>
<span class="im">import</span> WMTSSource <span class="im">from</span> <span class="st">&#39;ol/source/WMTS&#39;</span>
<span class="im">import</span> TileLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Tile.js&#39;</span>
<span class="im">import</span> WMTSTileGrid <span class="im">from</span> <span class="st">&#39;ol/tilegrid/WMTS.js&#39;</span>
<span class="im">import</span> <span class="op">{</span> get <span class="im">as</span> getProjection<span class="op">,</span> fromLonLat <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/proj&#39;</span>
<span class="im">import</span> <span class="op">{</span> getTopLeft<span class="op">,</span> getWidth <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/extent.js&#39;</span>

<span class="kw">const</span> projection <span class="op">=</span> <span class="at">getProjection</span>(<span class="st">&#39;EPSG:3857&#39;</span>)
<span class="kw">const</span> projectionExtent <span class="op">=</span> <span class="va">projection</span>.<span class="at">getExtent</span>()
<span class="kw">const</span> size <span class="op">=</span> <span class="at">getWidth</span>(projectionExtent) / <span class="dv">256</span>
<span class="kw">const</span> resolutions <span class="op">=</span> <span class="kw">new</span> <span class="at">Array</span>(<span class="dv">20</span>)
<span class="kw">const</span> matrixIds <span class="op">=</span> <span class="kw">new</span> <span class="at">Array</span>(<span class="dv">20</span>)

<span class="cf">for</span> (<span class="kw">let</span> z <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> z <span class="op">&lt;</span> <span class="dv">20</span><span class="op">;</span> <span class="op">++</span>z) <span class="op">{</span>
  <span class="co">// generate resolutions and matrixIds arrays for this WMTS</span>
  <span class="co">// see https://openlayers.org/en/latest/examples/wmts.html</span>
  resolutions[z] <span class="op">=</span> size / <span class="va">Math</span>.<span class="at">pow</span>(<span class="dv">2</span><span class="op">,</span> z)
  matrixIds[z] <span class="op">=</span> z
<span class="op">}</span>

<span class="kw">const</span> baseMapLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">TileLayer</span>(<span class="op">{</span>
  <span class="dt">extent</span><span class="op">:</span> projectionExtent<span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> <span class="kw">new</span> <span class="at">WMTSSource</span>(<span class="op">{</span>
    <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/tiles/service/wmts&#39;</span><span class="op">,</span>
    <span class="dt">layer</span><span class="op">:</span> <span class="st">&#39;brtachtergrondkaartgrijs&#39;</span><span class="op">,</span>
    <span class="dt">matrixSet</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span>
    <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;image/png&#39;</span><span class="op">,</span>
    <span class="dt">attributions</span><span class="op">:</span> <span class="st">&#39;Map data: &lt;a href=&quot;http://www.kadaster.nl&quot;&gt;Kadaster&lt;/a&gt;&#39;</span><span class="op">,</span>
    <span class="dt">tileGrid</span><span class="op">:</span> <span class="kw">new</span> <span class="at">WMTSTileGrid</span>(<span class="op">{</span>
      <span class="dt">origin</span><span class="op">:</span> <span class="at">getTopLeft</span>(projectionExtent)<span class="op">,</span>
      <span class="dt">resolutions</span><span class="op">:</span> resolutions<span class="op">,</span>
      <span class="dt">matrixIds</span><span class="op">:</span> matrixIds
    <span class="op">}</span>)<span class="op">,</span>
    <span class="dt">style</span><span class="op">:</span> <span class="st">&#39;default&#39;</span>
  <span class="op">}</span>)
<span class="op">}</span>)

<span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<div class="figure">
<img src="images/brta.png" title="BRT-Achtergrondkaart" alt="BRT-Achtergrondkaart" />
<p class="caption">BRT-Achtergrondkaart</p>
</div>
<p><a id="markdown-adding-wms-layer" name="adding-wms-layer"></a></p>
<h2 id="adding-wms-layer"><span class="header-section-number">3.3</span> Adding WMS Layer</h2>
<p>Now you are going to add a <a href="#web-map-service-wms">WMS</a> layer to your map as basemap layer.</p>
<p><a id="markdown-adding-wms-layer-to-viewer" name="adding-wms-layer-to-viewer"></a></p>
<h3 id="adding-wms-layer-to-viewer"><span class="header-section-number">3.3.1</span> Adding WMS Layer to Viewer</h3>
<p>Now we have good looking basemap it is time to display something on top of it.</p>
<p><a href="https://www.pdok.nl/introductie/-/article/nationaal-wegen-bestand-nwb-"><em>NWB Wegen</em></a> data set which is also published as a WMS service. The <em>Geo Services</em> tab provides a <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?request=GetCapabilities&amp;service=wms">WMS service url</a>. The URL provided links to the <code>capabilities</code> document, which describes what the service is capable of. The capabilities document lists which layers, styles, image formats and projections are available and more.</p>
<p>To add the <code>wegvakken</code> layer from the WMS service to the map add the following to the <code>index.js</code> document before the declaration of the <code>map</code> object.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> ImageLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Image&#39;</span>
<span class="im">import</span> ImageWMS <span class="im">from</span> <span class="st">&#39;ol/source/ImageWMS&#39;</span>

<span class="kw">const</span> wmsSource <span class="op">=</span> <span class="kw">new</span> <span class="at">ImageWMS</span>(<span class="op">{</span>
  <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/nwbwegen/wms?&#39;</span><span class="op">,</span>
  <span class="dt">crossOrigin</span><span class="op">:</span> <span class="st">&#39;anonymous&#39;</span><span class="op">,</span>
  <span class="dt">params</span><span class="op">:</span> <span class="op">{</span> <span class="dt">LAYERS</span><span class="op">:</span> <span class="st">&#39;wegvakken&#39;</span> <span class="op">}</span>
<span class="op">}</span>)

<span class="kw">const</span> wsmLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">ImageLayer</span>(<span class="op">{</span>
  <span class="dt">extent</span><span class="op">:</span> projectionExtent<span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> wmsSource
<span class="op">}</span>)</code></pre></div>
<p>Do not forget to add <code>wsmLayer</code> to the map object. We also need to set the zoomlevel of the initial view to <code>14</code> in order to see the WMS layer. This is due to the way this WMS service is configured, in the capabilities document the <code>wegvakken</code> layer has a <code>MaxScaleDenominator</code> property set to <code>50000</code>. This means that the layer is visible from scale <code>1:1</code> until <code>1:50000</code>. In terms of WMTS zoomlevels this means that layer is visible from zoomlevel <code>14</code> and up. The map object declaration should now look like this:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer<span class="op">,</span>
    wsmLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">14</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>Your map application should now display the <code>wegvakken</code> layer:</p>
<div class="figure">
<img src="images/wms_layer.png" title="WMS layer" alt="WMS layer" />
<p class="caption">WMS layer</p>
</div>
<p>You will notice that this WMS is pretty limited in what it can do, it is hard to get a complete view of dataset with all the restrictions. In the next section we will address this issue.</p>
<p><a id="markdown-adding-featureinfo-on-click-to-viewer" name="adding-featureinfo-on-click-to-viewer"></a></p>
<h3 id="adding-featureinfo-on-click-to-viewer"><span class="header-section-number">3.3.2</span> Adding Featureinfo on Click to Viewer</h3>
<p>The WMS standard provides a mechanism to retrieve information of features, the underlying vector data of the map. The request do retrieve feature information is called <code>GetFeatureInfo</code>. The WMS specification does not require the implementation of the <code>GetFeatureInfo</code> request, therefore a client should always check in the <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?request=GetCapabilities&amp;service=wms">capabilities document</a> if the service support the <code>GetFeatureInfo</code> request. The NWB-wegen WMS supports the <code>GetFeatureInfo</code> request, it is listed in the <code>Capability/Request</code> element in the XML.</p>
<p>In this section we are going to add functionality so show a popup with feature information when a users clicks on the map. To do this add the following to the <code>body</code> element of <code>index.html</code>, before the <code>script.js</code> inclusion:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;popup&quot;</span><span class="ot"> class=</span><span class="st">&quot;ol-popup&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;#&quot;</span><span class="ot"> id=</span><span class="st">&quot;popup-closer&quot;</span><span class="ot"> class=</span><span class="st">&quot;ol-popup-closer&quot;</span><span class="kw">&gt;&lt;/a&gt;</span>

    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;popup-content&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></div>
<p>Add the following code to <code>index.js</code> before the <code>map</code> constant declaration:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> Overlay <span class="im">from</span> <span class="st">&#39;ol/Overlay&#39;</span>

<span class="co">// Elements that make up the popup.</span>
<span class="kw">var</span> container <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup&#39;</span>)
<span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup-content&#39;</span>)
<span class="kw">var</span> closer <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;popup-closer&#39;</span>)

<span class="co">// Create an overlay to anchor the popup to the map.</span>
<span class="kw">var</span> overlay <span class="op">=</span> <span class="kw">new</span> <span class="at">Overlay</span>(<span class="op">{</span>
  <span class="dt">element</span><span class="op">:</span> container<span class="op">,</span>
  <span class="dt">autoPan</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="dt">autoPanAnimation</span><span class="op">:</span> <span class="op">{</span>
    <span class="dt">duration</span><span class="op">:</span> <span class="dv">250</span>
  <span class="op">}</span>
<span class="op">}</span>)

<span class="co">// Add a click handler to hide the popup.</span>
<span class="va">closer</span>.<span class="at">onclick</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="kw">undefined</span>)
  <span class="va">closer</span>.<span class="at">blur</span>()
  <span class="cf">return</span> <span class="kw">false</span>
<span class="op">}</span></code></pre></div>
<p>Add the <code>overlay</code> constant to the <code>map</code> object:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="op">{</span> <span class="co">// eslint-disable-line no-unused-vars</span>
  <span class="dt">layers</span><span class="op">:</span> [
    baseMapLayer<span class="op">,</span>
    wsmLayer
  ]<span class="op">,</span>
  <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span>
  <span class="dt">overlays</span><span class="op">:</span> [overlay]<span class="op">,</span>
  <span class="dt">view</span><span class="op">:</span> <span class="kw">new</span> <span class="at">View</span>(<span class="op">{</span>
    <span class="dt">center</span><span class="op">:</span> <span class="at">fromLonLat</span>([<span class="fl">5.43</span><span class="op">,</span> <span class="fl">52.18</span>])<span class="op">,</span>
    <span class="dt">zoom</span><span class="op">:</span> <span class="dv">14</span>
  <span class="op">}</span>)
<span class="op">}</span>)</code></pre></div>
<p>Add the <code>singleclick</code> eventhandler on the map object below the <code>map</code> declaration in <code>index.js</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">map</span>.<span class="at">on</span>(<span class="st">&#39;singleclick&#39;</span><span class="op">,</span> <span class="kw">function</span>(evt) <span class="op">{</span>
  <span class="co">// clean content of popup on every new singeclick event</span>
  <span class="cf">if</span> (<span class="va">content</span>.<span class="va">childNodes</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="va">content</span>.<span class="at">childNodes</span>[<span class="dv">0</span>].<span class="at">remove</span>()
  <span class="kw">var</span> viewResolution <span class="op">=</span> <span class="co">/** </span><span class="an">@type</span><span class="co"> {number} */</span> (<span class="va">map</span>.<span class="at">getView</span>().<span class="at">getResolution</span>())<span class="op">;</span>
  <span class="kw">var</span> url <span class="op">=</span> <span class="va">wmsSource</span>.<span class="at">getFeatureInfoUrl</span>(
    <span class="va">evt</span>.<span class="at">coordinate</span><span class="op">,</span> viewResolution<span class="op">,</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span>
    <span class="op">{</span><span class="st">&#39;INFO_FORMAT&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">}</span>)<span class="op">;</span>
  <span class="cf">if</span> (url) <span class="op">{</span>
    <span class="at">fetch</span>(url)
      .<span class="at">then</span>(<span class="kw">function</span> (response) <span class="op">{</span> <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>() <span class="op">}</span>)
      .<span class="at">then</span>(<span class="kw">function</span> (data) <span class="op">{</span>
        <span class="co">// set overlay position to undefined to hide popup</span>
        <span class="cf">if</span> (<span class="va">data</span>.<span class="va">features</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>)<span class="op">{</span>
          <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="kw">undefined</span>)
          <span class="cf">return</span>
        <span class="op">}</span>
        <span class="kw">let</span> ft <span class="op">=</span> <span class="va">data</span>.<span class="at">features</span>[<span class="dv">0</span>]
        <span class="kw">let</span> table <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;table&quot;</span>)
        <span class="kw">var</span> header <span class="op">=</span> <span class="va">table</span>.<span class="at">createTHead</span>()
        <span class="kw">var</span> row <span class="op">=</span> <span class="va">header</span>.<span class="at">insertRow</span>()
        <span class="kw">let</span> i<span class="op">=</span><span class="dv">0</span>
        <span class="va">Object</span>.<span class="at">keys</span>(<span class="va">ft</span>.<span class="at">properties</span>).<span class="at">forEach</span>(<span class="kw">function</span>(item)<span class="op">{</span>
          <span class="kw">let</span> cell <span class="op">=</span> <span class="va">row</span>.<span class="at">insertCell</span>(i)
          <span class="va">cell</span>.<span class="at">innerHTML</span> <span class="op">=</span> item
          i<span class="op">++</span>
        <span class="op">}</span>)
        <span class="kw">let</span> body <span class="op">=</span> <span class="va">table</span>.<span class="at">createTBody</span>()
        row <span class="op">=</span> <span class="va">body</span>.<span class="at">insertRow</span>()
        i<span class="op">=</span><span class="dv">0</span>
        <span class="va">Object</span>.<span class="at">keys</span>(<span class="va">ft</span>.<span class="at">properties</span>).<span class="at">forEach</span>(<span class="kw">function</span>(item)<span class="op">{</span>
          <span class="kw">let</span> cell <span class="op">=</span> <span class="va">row</span>.<span class="at">insertCell</span>(i)
          <span class="va">cell</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">ft</span>.<span class="at">properties</span>[item]
          i<span class="op">++</span>
        <span class="op">}</span>)
        <span class="va">content</span>.<span class="at">appendChild</span>(table)
        <span class="va">overlay</span>.<span class="at">setPosition</span>(<span class="va">evt</span>.<span class="at">coordinate</span>)
      <span class="op">}</span>)
  <span class="op">}</span>
<span class="op">}</span>)</code></pre></div>
<p>Create a new <code>index.css</code> file in the root of the <code>webapp</code> folder and add the following CSS:</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css">html, body {
    <span class="kw">height</span>: <span class="dv">100%</span>;
    <span class="kw">margin</span>: <span class="dv">0px</span>;
}


<span class="pp">#map</span> {
    <span class="kw">height</span>: <span class="dv">100%</span>;
}

<span class="fu">.ol-popup</span> {
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">background-color</span>: <span class="dv">white</span>;
    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">1px</span> <span class="dv">4px</span> <span class="fu">rgba</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0.2</span>);
    <span class="kw">padding</span>: <span class="dv">15px</span>;
    <span class="kw">border-radius</span>: <span class="dv">10px</span>;
    <span class="kw">border</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#cccccc</span>;
    <span class="kw">bottom</span>: <span class="dv">12px</span>;
    <span class="kw">left</span>: <span class="dv">-50px</span>;
    <span class="kw">min-width</span>: <span class="dv">40vw</span>;
    <span class="kw">max-width</span>: <span class="dv">60vw</span>;
    <span class="kw">padding-top</span>: <span class="dv">20px</span>;
}

<span class="fu">.ol-popup</span><span class="in">:after</span>, <span class="fu">.ol-popup</span><span class="in">:before</span> {
    <span class="kw">top</span>: <span class="dv">100%</span>;
    <span class="kw">border</span>: <span class="dv">solid</span> <span class="dv">transparent</span>;
    <span class="kw">content</span>: <span class="st">&quot; &quot;</span>;
    <span class="kw">height</span>: <span class="dv">0</span>;
    <span class="kw">width</span>: <span class="dv">0</span>;
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">pointer-events</span>: <span class="dv">none</span>;
}

<span class="fu">.ol-popup</span><span class="in">:after</span> {
    <span class="kw">border-top-color</span>: <span class="dv">white</span>;
    <span class="kw">border-width</span>: <span class="dv">10px</span>;
    <span class="kw">left</span>: <span class="dv">48px</span>;
    <span class="kw">margin-left</span>: <span class="dv">-10px</span>;
}

<span class="fu">.ol-popup</span><span class="in">:before</span> {
    <span class="kw">border-top-color</span>: <span class="dv">#cccccc</span>;
    <span class="kw">border-width</span>: <span class="dv">11px</span>;
    <span class="kw">left</span>: <span class="dv">48px</span>;
    <span class="kw">margin-left</span>: <span class="dv">-11px</span>;
}

<span class="fu">.ol-popup-closer</span> {
    <span class="kw">text-decoration</span>: <span class="dv">none</span>;
    <span class="kw">position</span>: <span class="dv">absolute</span>;
    <span class="kw">top</span>: <span class="dv">2px</span>;
    <span class="kw">right</span>: <span class="dv">8px</span>;
}

<span class="fu">.ol-popup-closer</span><span class="in">:visited</span> {
    <span class="kw">text-decoration</span>: <span class="dv">inherit</span>;
    <span class="kw">color</span>: <span class="dv">inherit</span>;
    <span class="kw">cursor</span>: <span class="dv">auto</span>;
}

<span class="fu">.ol-popup-closer</span><span class="in">:after</span> {
    <span class="kw">content</span>: <span class="st">&quot;&quot;</span>;
}


<span class="pp">#popup-content</span> {
    <span class="kw">overflow-x</span>: <span class="dv">scroll</span>;
}

table {
    <span class="kw">border</span>: <span class="dv">none</span>;
    <span class="kw">border-collapse</span>: <span class="dv">collapse</span>;
    <span class="kw">font-family</span>: <span class="dv">sans-serif</span>;
}

table td {
    <span class="kw">border-left</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">border-right</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">padding-left</span>: <span class="dv">0.5em</span>;
    <span class="kw">padding-right</span>: <span class="dv">0.5em</span>;
}

thead&gt;tr&gt;td {
    <span class="kw">border-bottom</span>: <span class="dv">1px</span> <span class="dv">solid</span> <span class="dv">#ddd</span>;
    <span class="kw">font-weight</span>: <span class="dv">600</span>;
}

table td<span class="in">:first-child</span> {
    <span class="kw">border-left</span>: <span class="dv">none</span>;
}

table td<span class="in">:last-child</span> {
    <span class="kw">border-right</span>: <span class="dv">none</span>;
}

tbody td<span class="in">:nth-of-type</span>(odd), thead td<span class="in">:nth-of-type</span>(odd) {
    <span class="kw">background</span>: <span class="dv">#E6E6E6</span>;
}</code></pre></div>
<p>Remove the <code>style</code> element from the <code>index.html</code> file and replace with:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> type=</span><span class="st">&quot;text/css&quot;</span><span class="ot"> href=</span><span class="st">&quot;index.css&quot;</span><span class="kw">&gt;</span></code></pre></div>
<p>Reload the webapp in the browser,now the map should display a popover when a feature is clicked on the map.</p>
<div class="figure">
<img src="images/get_feature_info.png" title="Feature information" alt="Feature information" />
<p class="caption">Feature information</p>
</div>
<p>What happens in the background is that OpenLayers registers on which pixel coordinate a user clicks. This is information is combined with the query parameters of the previous WMS <code>GetMap</code> request, to create a <code>GetFeatureInfo</code> request. In the below example <code>GetFeatureInfo</code> request the user clicked on pixel coordinate <code>50,50</code> of an image with <code>WIDTH</code> and <code>HEIGHT</code> of <code>101,101</code>, <a href="https://geodata.nationaalgeoregister.nl/nwbwegen/wms?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetMap&amp;FORMAT=image%2Fpng&amp;TRANSPARENT=true&amp;LAYERS=wegvakken&amp;CRS=EPSG%3A3857&amp;STYLES=&amp;WIDTH=101&amp;HEIGHT=101&amp;BBOX=603781.6790671768%2C6831433.221161786%2C604746.696549277%2C6832398.238643886">this</a> is the corresponding <code>GetMap</code> request.</p>
<pre class="http"><code>https://geodata.nationaalgeoregister.nl/nwbwegen/wms?SERVICE=WMS&amp;
VERSION=1.3.0&amp;
REQUEST=GetFeatureInfo&amp;
FORMAT=image%2Fpng&amp;
TRANSPARENT=true&amp;
QUERY_LAYERS=wegvakken&amp;
LAYERS=wegvakken&amp;
INFO_FORMAT=application%2Fjson&amp;
I=50&amp;
J=50&amp;
CRS=EPSG%3A3857&amp;
STYLES=&amp;
WIDTH=101&amp;
HEIGHT=101&amp;
BBOX=603781.6790671768%2C6831433.221161786%2C604746.696549277%2C6832398.238643886</code></pre>
<p><a id="markdown-adding-a-geojson-layer" name="adding-a-geojson-layer"></a></p>
<h2 id="adding-a-geojson-layer"><span class="header-section-number">3.4</span> Adding a GeoJSON Layer</h2>
<p>A different approach to displaying geographical data is, instead of using WMS and WMTS services, downloading the vector data in the client and displaying the vector data directly. In this scenario there is no need for a server and gives you complete freedom of styling of the data. One major drawback of this approach is performance, processing power on the client is limited; there is a upper limit on the number of features you can load in your map (at once).</p>
<p>When rendering geographical data directly on the client rendering performance is a concern. You can optimize for this by preprocessing your data to either:</p>
<ol style="list-style-type: decimal">
<li>Reduce the size of the data set by removing features</li>
<li>Reduce the size of the data set by simplification of the geometries (aggregation, generalization)</li>
</ol>
<p>In this workshop we only do preprocessing of the data to reduce the size of the data set. This is done by selecting only the motorways (the <em>A</em> roads) and joining the separate segments into one geometry grouped by the road letter and road number combination (for instance group by A1, A2, A348). We will use the <a href="https://gdal.org/programs/ogr2ogr.html"><code>ogr2ogr</code></a> commandline utility for data processing.</p>
<p><a id="markdown-data-preprocessing" name="data-preprocessing"></a></p>
<h3 id="data-preprocessing"><span class="header-section-number">3.4.1</span> Data Preprocessing</h3>
<p>In this chapter you are going to create a map of the Dutch motor ways, directly rendered in the browser from a GeoJSON file. We will use the <a href="https://www.pdok.nl/introductie/-/article/nationaal-wegen-bestand-nwb-">NWB-wegen data set</a>, PDOK provides WMS en WFS services and also a direct download service. In this case we will use the PDOK download service, since we want to obtain the full data set.</p>
<blockquote>
<p><strong>NOTE:</strong> If you are using the VirtualBox image that comes with the workshop you do not need to download the file, it is already downloaded in <code>~/pdok-webservices-workshop/data</code>.</p>
</blockquote>
<p>First ensure your current working directory is <code>~/pdok-webservices-workshop</code> (the root folder of this project):</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> ~/pdok-webservices-workshop</code></pre></div>
<p>The data we are going to use is available in the <code>./data</code> folder of this project. If needed the file can be downloaded through the following command.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> <span class="st">&quot;http://geodata.nationaalgeoregister.nl/nwbwegen/extract/nwbwegen.zip&quot;</span> -o data/nwbwegen.zip</code></pre></div>
<p>Then unzip:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">unzip</span> data/nwbwegen.zip -d data/</code></pre></div>
<p>Open the Shapefile in QGIS to inspect data from the NWB-wegen data set, Shapefile is located in <code>data/geogegevens/shapefile/nederland_totaal/wegvakken/wegvakken.shp</code>. This file can also be drag&amp;drop in QGIS.</p>
<div class="figure">
<img src="images/qgis_nwb.png" title="NWB Wegen in QGIS" alt="NWB Wegen in QGIS" />
<p class="caption">NWB Wegen in QGIS</p>
</div>
<p>You will notice that it takes some processing for QGIS to render all the features when viewing the full extent of the Netherlands. This is a sure sign your browser will have a hard time rendering all this data. To make life easy for the browser we will extract only the motorways from this data set.</p>
<p>Another concern is that the roads in the <code>wegvakken</code> layer from NWB-wegen are divided in many separate segments. This is not ideal for styling and labeling the in the webapp. Therefore we need to merge the geometries, and we can immediately group them by route-letter and route-number (A2, A10, A348).</p>
<p>First step is to convert the shapefile to GPKG and select only the <code>A</code> routes (<a href="https://en.wikipedia.org/wiki/GeoPackage">GeoPackage</a> is the superior geospatial file format, although Shapefile is <a href="https://twitter.com/shapefiie">refusing</a> to go away).</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -f GPKG data/nwb.gpkg data/geogegevens/shapefile/nederland_totaal/wegvakken/wegvakken.shp -sql <span class="st">&quot;select * from wegvakken where routeltr = &#39;A&#39;&quot;</span> -nln wegvakken_a</code></pre></div>
<p>The add a new column <code>route</code> to the wegvakken table and set the value to <code>routeltr+routenr</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogrinfo</span> data/nwb.gpkg -sql <span class="st">&quot;alter table wegvakken_a add column route TEXT&quot;</span>
<span class="ex">ogrinfo</span> data/nwb.gpkg -sql <span class="st">&quot;update wegvakken_a set route=routeltr||routenr&quot;</span></code></pre></div>
<p>Now you are ready to group the geometries by the newly created <code>route</code> attribute and merge geometries of this group:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -update -f GPKG  data/nwb.gpkg data/nwb.gpkg -sql <span class="st">&quot;SELECT ST_Union(_ogr_geometry_) as geom, route FROM wegvakken_a GROUP BY route&quot;</span> -nln snelwegen -nlt MULTILINESTRING</code></pre></div>
<p>Now convert the <code>snelwegen</code> layer in the GPKG to GeoJSON:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ogr2ogr</span> -f GeoJSON data/snelwegen.json data/nwb.gpkg -sql <span class="st">&quot;select geom, route from snelwegen&quot;</span> -t_srs EPSG:3857 -nln snelwegen</code></pre></div>
<p>Open <code>snelwegen.json</code> in QGIS, to verify whether you see the expected output, compare it with the intermediate layers in <code>data/nwb.gpkg</code>. You can style the layer based on the <code>route</code> attribute:</p>
<div class="figure">
<img src="images/qgis_snelwegen.png" title="Snelwegen in QGIS" alt="Snelwegen in QGIS" />
<p class="caption">Snelwegen in QGIS</p>
</div>
<p>Then copy the <code>snelwegen.json</code> file to the <code>webapp</code> folder.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">cp</span> data/snelwegen.json webapp/</code></pre></div>
<p><a id="markdown-adding-geojson-as-a-layer" name="adding-geojson-as-a-layer"></a></p>
<h3 id="adding-geojson-as-a-layer"><span class="header-section-number">3.4.2</span> Adding GeoJSON as a Layer</h3>
<p>Next we need to add some imports to the <code>index.js</code> file to display the GeoJSON file in your webapp:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> Point <span class="im">from</span> <span class="st">&#39;ol/geom/Point&#39;</span>
<span class="im">import</span> <span class="op">{</span> Text<span class="op">,</span> Fill<span class="op">,</span> Stroke<span class="op">,</span> Style <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/style&#39;</span>
<span class="im">import</span> MultiLineString <span class="im">from</span> <span class="st">&#39;ol/geom/MultiLineString&#39;</span>
<span class="im">import</span> VectorLayer <span class="im">from</span> <span class="st">&#39;ol/layer/Vector&#39;</span>
<span class="im">import</span> <span class="op">{</span> getCenter <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/extent&#39;</span>
<span class="im">import</span> <span class="op">{</span> Vector <span class="im">as</span> VectorSource <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/source&#39;</span>
<span class="im">import</span> GeoJSON <span class="im">from</span> <span class="st">&#39;ol/format/GeoJSON&#39;</span>
<span class="im">import</span> snelwegen <span class="im">from</span> <span class="st">&#39;./snelwegen.json&#39;</span></code></pre></div>
<p>Remove the WMS layer and the click event handler, we are going to replace these with the GeoJSON layer.</p>
<p>Add the following to <code>index.js</code> <strong>and</strong> do not forget to add the <code>snelwegenLayer</code> to the <code>map</code> object:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">styleFunc</span> (feature) <span class="op">{</span>
  <span class="kw">const</span> styles <span class="op">=</span> [
    <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">5</span>
      <span class="op">}</span>)
    <span class="op">}</span>)<span class="op">,</span>
    <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span>
      <span class="op">}</span>)
    <span class="op">}</span>)
  ]
  <span class="va">styles</span>.<span class="at">push</span>(<span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
    <span class="dt">geometry</span><span class="op">:</span> <span class="kw">function</span> (feature) <span class="op">{</span>
      <span class="kw">var</span> multiLineString <span class="op">=</span> <span class="kw">new</span> <span class="at">MultiLineString</span>(<span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getCoordinates</span>())
      <span class="co">// labelPoint is the closest point on the line from the center of the extent of the geometry</span>
      <span class="kw">var</span> labelPoint <span class="op">=</span> <span class="va">multiLineString</span>.<span class="at">getClosestPoint</span>(<span class="at">getCenter</span>(<span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getExtent</span>()))
      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Point</span>(labelPoint)
    <span class="op">},</span>
    <span class="dt">text</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Text</span>(<span class="op">{</span>
      <span class="dt">text</span><span class="op">:</span> <span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>)<span class="op">,</span>
      <span class="dt">font</span><span class="op">:</span> <span class="st">&#39;1em sans-serif&#39;</span><span class="op">,</span>
      <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span>
        <span class="dt">width</span><span class="op">:</span> <span class="dv">6</span>
      <span class="op">}</span>)<span class="op">,</span>
      <span class="dt">fill</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Fill</span>(<span class="op">{</span>
        <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span>
      <span class="op">}</span>)<span class="op">,</span>
      <span class="dt">overflow</span><span class="op">:</span> <span class="kw">true</span>
    <span class="op">}</span>)
  <span class="op">}</span>))
  <span class="cf">return</span> styles
<span class="op">}</span>

<span class="kw">const</span> snelwegenSource <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorSource</span>(<span class="op">{</span>
  <span class="dt">features</span><span class="op">:</span> (<span class="kw">new</span> <span class="at">GeoJSON</span>(
  )).<span class="at">readFeatures</span>(snelwegen)
<span class="op">}</span>)

<span class="kw">const</span> snelwegenLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">source</span><span class="op">:</span> snelwegenSource<span class="op">,</span>
  <span class="dt">style</span><span class="op">:</span> styleFunc<span class="op">,</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)</code></pre></div>
<blockquote>
<p><strong>NOTE:</strong> you can also remove the popup div from <code>index.html</code>, in that case do not forget to also remove the <code>closer</code> variable from the <code>index.js</code> file.</p>
</blockquote>
<p>Refresh your browser to see the result:</p>
<div class="figure">
<img src="images/geojson_layer.png" title="GeoJSON layer" alt="GeoJSON layer" />
<p class="caption">GeoJSON layer</p>
</div>
<p>With a simple modification of the style function the labeling can be made dynamic, based on the extent of the current view, this way all features in the current view are labeled. You can replace the <code>var labelPoint</code> in the <code>function styleFunc</code>:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> labelPoint <span class="op">=</span> <span class="va">multiLineString</span>.<span class="at">getClosestPoint</span>(<span class="at">getCenter</span>(<span class="va">map</span>.<span class="at">getView</span>().<span class="at">calculateExtent</span>(<span class="va">map</span>.<span class="at">getSize</span>())))</code></pre></div>
<p>However this is not an ideal solution either due to the jumping labels on panning and <code>zoomchange</code> by the user. This can off course also be solved client side, but as you may realize labeling features is not a trivial problem.</p>
<p>Since we have the actual vector data loaded in the viewer, it is fairly easy to highlight features that have been clicked. Add the following to <code>index.js</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">var</span> selection <span class="op">=</span> <span class="op">{}</span>

<span class="kw">const</span> selectionLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
  <span class="dt">source</span><span class="op">:</span> <span class="va">snelwegenLayer</span>.<span class="at">getSource</span>()<span class="op">,</span>
  <span class="dt">style</span><span class="op">:</span> <span class="kw">function</span> (feature) <span class="op">{</span>
    <span class="cf">if</span> (<span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>) <span class="kw">in</span> selection) <span class="op">{</span>
      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Style</span>(<span class="op">{</span>
        <span class="dt">stroke</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Stroke</span>(<span class="op">{</span>
          <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span>
          <span class="dt">width</span><span class="op">:</span> <span class="fl">1.5</span>
        <span class="op">}</span>)
      <span class="op">}</span>)
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>)

<span class="va">map</span>.<span class="at">on</span>([<span class="st">&#39;click&#39;</span>]<span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>
  <span class="kw">const</span> features <span class="op">=</span> <span class="va">map</span>.<span class="at">getFeaturesAtPixel</span>(<span class="va">event</span>.<span class="at">pixel</span><span class="op">,</span> <span class="op">{</span> <span class="dt">hitTolerance</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)
  <span class="cf">if</span> (<span class="op">!</span><span class="va">features</span>.<span class="at">length</span>) <span class="op">{</span>
    selection <span class="op">=</span> <span class="op">{}</span>
    <span class="va">selectionLayer</span>.<span class="at">changed</span>()
    <span class="cf">return</span>
  <span class="op">}</span>
  <span class="kw">const</span> feature <span class="op">=</span> features[<span class="va">features</span>.<span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]
  <span class="kw">const</span> identifier <span class="op">=</span> <span class="va">feature</span>.<span class="at">get</span>(<span class="st">&#39;route&#39;</span>)
  selection <span class="op">=</span> <span class="op">{}</span>
  selection[identifier] <span class="op">=</span> feature
  <span class="va">selectionLayer</span>.<span class="at">changed</span>()
<span class="op">}</span>)</code></pre></div>
<p>Do not forget to add the new <code>selectionLayer</code> to the map. Now when a feature on the map is clicked it will be highlighted.</p>
<div class="figure">
<img src="images/geojson_highlight.png" title="GeoJSON highlight" alt="GeoJSON highlight" />
<p class="caption">GeoJSON highlight</p>
</div>
<p><a id="markdown-using-the-pdok-location-server" name="using-the-pdok-location-server"></a></p>
<h2 id="using-the-pdok-location-server"><span class="header-section-number">3.5</span> Using the PDOK Location Server</h2>
<p>The <a href="https://github.com/PDOK/locatieserver/wiki/API-Locatieserver">PDOK Locatie Server</a> might be the only PDOK service that does not implement a standardized service protocol. This probably due to the fact that there is no existing open standard for <a href="https://en.wikipedia.org/wiki/Gazetteer">Gazetteer</a> services. The PDOK Locatie Server allows to query locations by text; so you could ask the location in lat/long coordinates for <code>Steenstraat Arnhem</code>.</p>
<p>In this section we are going to add a input control to the map that accepts text. This text will be used to query the Locatie Server, and then display the results on the map.</p>
<p><a id="markdown-adding-custom-control" name="adding-custom-control"></a></p>
<h3 id="adding-custom-control"><span class="header-section-number">3.5.1</span> Adding Custom Control</h3>
<p>To make life easier you will install the <a href="https://www.npmjs.com/package/autocompleter"><code>autocompleter</code></a> npm dependency. This will take care of showing the list of suggestion for the input and take care of all the required event handling.</p>
<p>First install the autocomplete npm dependency, from the webapp folder run:</p>
<pre><code>npm install autocompleter</code></pre>
<p>Remove <code>popup</code> html elements from <code>index.html</code> and remove the <code>closer</code> variable from the <code>index.js</code> file. Then add to <code>index.css</code>:</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fu">.ol-zoom.ol-control</span> {
  <span class="kw">top</span>: <span class="dv">2em</span>;
}</code></pre></div>
<p>Now add to <code>index.js</code>:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> <span class="op">{</span> Control <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;ol/control&#39;</span>
<span class="im">import</span> WKT <span class="im">from</span> <span class="st">&#39;ol/format/WKT&#39;</span>
<span class="im">import</span> autocomplete <span class="im">from</span> <span class="st">&#39;autocompleter&#39;</span>
<span class="im">import</span> <span class="st">&#39;autocompleter/autocomplete.css&#39;</span>

<span class="kw">const</span> locatieServerUrl <span class="op">=</span> <span class="st">&#39;https://geodata.nationaalgeoregister.nl/locatieserver/v3&#39;</span>

<span class="kw">var</span> LocationServerControl <span class="op">=</span> <span class="co">/* @__PURE__ */</span>(<span class="kw">function</span> (Control) <span class="op">{</span>
  <span class="kw">function</span> <span class="at">LocationServerControl</span> (optOptions) <span class="op">{</span>
    <span class="kw">var</span> options <span class="op">=</span> optOptions <span class="op">||</span> <span class="op">{}</span>
    <span class="kw">var</span> input <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&#39;input&#39;</span>)
    <span class="va">input</span>.<span class="at">id</span> <span class="op">=</span> <span class="st">&#39;input-loc&#39;</span>
    <span class="kw">var</span> element <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&#39;div&#39;</span>)
    <span class="va">element</span>.<span class="at">className</span> <span class="op">=</span> <span class="st">&#39;input-loc ol-unselectable ol-control&#39;</span>
    <span class="va">element</span>.<span class="at">appendChild</span>(input)
    <span class="va">Control</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="op">{</span>
      <span class="dt">element</span><span class="op">:</span> element<span class="op">,</span>
      <span class="dt">target</span><span class="op">:</span> <span class="va">options</span>.<span class="at">target</span>
    <span class="op">}</span>)
  <span class="op">}</span>
  <span class="co">/* eslint no-proto: 0 */</span>
  <span class="cf">if</span> (Control) <span class="va">LocationServerControl</span>.<span class="at">__proto__</span> <span class="op">=</span> Control
  <span class="va">LocationServerControl</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">Object</span>.<span class="at">create</span>(Control <span class="op">&amp;&amp;</span> <span class="va">Control</span>.<span class="at">prototype</span>)
  <span class="va">LocationServerControl</span>.<span class="va">prototype</span>.<span class="at">constructor</span> <span class="op">=</span> LocationServerControl
  <span class="cf">return</span> LocationServerControl
<span class="op">}</span>(Control))

<span class="va">map</span>.<span class="at">addControl</span>(<span class="kw">new</span> <span class="at">LocationServerControl</span>())</code></pre></div>
<p>If correct the map should display an input control:</p>
<div class="figure">
<img src="images/autocomp-1.png" title="Autocomplete input" alt="Autocomplete input" />
<p class="caption">Autocomplete input</p>
</div>
<p><a id="markdown-get-suggestions-from-locatie-server" name="get-suggestions-from-locatie-server"></a></p>
<h3 id="get-suggestions-from-locatie-server"><span class="header-section-number">3.5.2</span> Get Suggestions from Locatie Server</h3>
<p>Nothing happens when you start typing in the input control. Let's change that! Add the the following to the <code>function LocationServerControl</code> below the <code>Control.call</code> section:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="at">autocomplete</span>(<span class="op">{</span>
      <span class="dt">input</span><span class="op">:</span> input<span class="op">,</span>
      <span class="dt">fetch</span><span class="op">:</span> <span class="kw">function</span> (text<span class="op">,</span> update) <span class="op">{</span>
        <span class="at">fetch</span>(<span class="vs">`</span><span class="sc">${</span>locatieServerUrl<span class="sc">}</span><span class="vs">/suggest?q=</span><span class="sc">${</span>text<span class="sc">}</span><span class="vs">`</span>)
          .<span class="at">then</span>((response) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()
          <span class="op">}</span>)
          .<span class="at">then</span>((data) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">const</span> suggestions <span class="op">=</span> []
            <span class="va">data</span>.<span class="va">response</span>.<span class="va">docs</span>.<span class="at">forEach</span>(<span class="kw">function</span> (item) <span class="op">{</span>
              <span class="kw">const</span> name <span class="op">=</span> <span class="va">item</span>.<span class="at">weergavenaam</span>
              <span class="kw">const</span> id <span class="op">=</span> <span class="va">item</span>.<span class="at">id</span>
              <span class="va">suggestions</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">label</span><span class="op">:</span> name<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> id <span class="op">}</span>)
            <span class="op">}</span>)
            <span class="at">update</span>(suggestions)
          <span class="op">}</span>)
      <span class="op">}</span>
    <span class="op">}</span>)</code></pre></div>
<p>Now the control should display the suggestions:</p>
<div class="figure">
<img src="images/autocomp-2.png" title="Autocomplete suggestions" alt="Autocomplete suggestions" />
<p class="caption">Autocomplete suggestions</p>
</div>
<p><a id="markdown-get-result-from-locatie-server" name="get-result-from-locatie-server"></a></p>
<h3 id="get-result-from-locatie-server"><span class="header-section-number">3.5.3</span> Get Result from Locatie Server</h3>
<p>Nothing happens when you select one of the autosuggest items, let's fix that. Add the following code below the <code>fetch</code> property in the <code>autocomplete</code> body:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">onSelect<span class="op">:</span> <span class="kw">function</span> (item) <span class="op">{</span>
        <span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> <span class="va">item</span>.<span class="at">label</span>
        <span class="kw">const</span> id <span class="op">=</span> <span class="va">item</span>.<span class="at">value</span>
        <span class="at">fetch</span>(<span class="vs">`</span><span class="sc">${</span>locatieServerUrl<span class="sc">}</span><span class="vs">/lookup?id=</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">&amp;fl=id,geometrie_ll`</span>)
          .<span class="at">then</span>((response) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()
          <span class="op">}</span>)
          .<span class="at">then</span>((data) <span class="op">=&gt;</span> <span class="op">{</span>
            <span class="kw">const</span> wktLoc <span class="op">=</span> <span class="va">data</span>.<span class="va">response</span>.<span class="at">docs</span>[<span class="dv">0</span>].<span class="at">geometrie_ll</span>
            <span class="kw">const</span> format <span class="op">=</span> <span class="kw">new</span> <span class="at">WKT</span>()
            <span class="kw">const</span> feature <span class="op">=</span> <span class="va">format</span>.<span class="at">readFeature</span>(wktLoc<span class="op">,</span> <span class="op">{</span>
              <span class="dt">dataProjection</span><span class="op">:</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">,</span>
              <span class="dt">featureProjection</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span>
            <span class="op">}</span>)
            <span class="kw">const</span> ext <span class="op">=</span> <span class="va">feature</span>.<span class="at">getGeometry</span>().<span class="at">getExtent</span>()
            <span class="va">map</span>.<span class="at">getView</span>().<span class="at">fit</span>(ext<span class="op">,</span> <span class="va">map</span>.<span class="at">getSize</span>())
          <span class="op">}</span>)
      <span class="op">}</span></code></pre></div>
<p>When you click an autosuggest item, the map will zoom to the location of the selected object. This can still be improved, as you can see, the <code>lookup</code> endpoint returns a geometry of the requested object. You can make this geometry visible by creating a <code>VectorSource</code> and <code>VectorLayer</code>, add the feature to the <code>VectorSource</code> and add the <code>VectorLayer</code> to the map.</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> vectorSource <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorSource</span>()

<span class="kw">const</span> vectorLayer <span class="op">=</span> <span class="kw">new</span> <span class="at">VectorLayer</span>(<span class="op">{</span>
  <span class="dt">source</span><span class="op">:</span> vectorSource<span class="op">,</span>
  <span class="dt">declutter</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)</code></pre></div>
<p>In the promise fulfillment of the <code>lookup</code> fetch add after creating the feature form WKT:</p>
<div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="va">vectorSource</span>.<span class="at">clear</span>()
<span class="va">vectorSource</span>.<span class="at">addFeature</span>(feature)</code></pre></div>
<p>Now when you select an item from the autosuggest list, the viewer will zoom to the object and display the geometry of the object on the map:</p>
<div class="figure">
<img src="images/autocomp-3.png" title="Autocomplete geometry" alt="Autocomplete geometry" />
<p class="caption">Autocomplete geometry</p>
</div>
<hr />
<p>This concludes the workshop, congratulations to you for making it to the end! Now you can call yourself a commandline cartographer and build your own web map application. If your interested in more commandline cartography workshops make sure to check out the <a href="https://medium.com/@mbostock/command-line-cartography-part-1-897aa8f8ca2c">Command-Line Cartography</a> blog posts by Mike Bostock. These workshop have a different approach, by using JavaScript based commandline tooling to process GeoJSON and TopoJSON and render them into SVG files, which can be displayed directly in the browser. No need for OpenLayers!</p>
</body>
</html>
